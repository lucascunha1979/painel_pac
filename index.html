<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel do Novo PAC ‚Äì Rio Grande do Sul</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{ --bg:#ffffff; --panel:#f4f5f7; --text:#111; --muted:#555; --accent:#e11d2e; }
.dark { --bg:#0a0a0a; --panel:#181a1b; --text:#fff; --muted:#c9c9c9; --accent:#ef4444; }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;padding:18px;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
.wrap{max-width:1500px;margin:0 auto}
h1{margin:0 0 6px;font-size:26px}
h2{margin:0 0 10px;font-size:20px;color:var(--accent)}
.meta{color:var(--muted);margin-bottom:10px}
.card{background:var(--panel);border:1px solid #d6d7da;border-radius:12px;padding:16px;margin:0 0 18px}
.dark .card{border-color:#2a2d2f}
select{padding:8px 10px;border:1px solid #b9bdc0;border-radius:8px;background:var(--bg);color:var(--text);margin-right:10px}
.dark select{border-color:#3c4043}
.btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
.btn-accent{background:var(--accent);color:#fff}
.btn-muted{background:#999;color:#fff}
.topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto;display:flex;gap:8px}
#valorTotal{background:var(--accent);color:#fff;padding:14px;border-radius:12px;text-align:center;font-size:28px;font-weight:700}
.kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpi{background:var(--panel);border:1px solid #d6d7da;border-radius:10px;padding:10px 12px;min-width:180px}
.dark .kpi{border-color:#2a2d2f}
.kpi b{display:block;font-size:18px;margin-top:4px}
.chart{height:420px}
.scroll-x{overflow-x:auto}
.scroll-y{max-height:750px;overflow-y:auto}
.chart.wide{width:1700px}
.chart.wider{width:2200px}
.badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.badge{background:#e8eaed;color:#111;border-radius:20px;padding:4px 10px;font-size:12px;border:1px solid #cfd1d4}
.dark .badge{background:#2a2d2f;color:#fff;border-color:#3a3d40}
.badge .x{margin-left:6px;cursor:pointer}
.small{font-size:12px;color:var(--muted)}
#errorBox{display:none;margin:12px 0;padding:12px;border-radius:8px;background:#ffe8e8;color:#8b0000;border:1px solid #f3bcbc}
</style>
</head>
<body class="">
<div class="wrap" id="pagina">
  <div class="topbar">
    <div>
      <h1>Painel do Novo PAC ‚Äì Rio Grande do Sul</h1>
      <div class="meta">Fonte: Novo PAC ‚Äì Casa Civil ‚Äì Governo Federal ‚Äî Atualiza√ß√£o Agosto/2025</div>
    </div>
    <div class="right">
      <button id="themeBtn" class="btn btn-accent" title="Alternar tema">üåô/‚òÄÔ∏è</button>
      <button id="pdfBtn" class="btn btn-accent" title="Baixar PDF">üìÑ PDF</button>
    </div>
  </div>

  <div id="errorBox"></div>

  <div id="valorTotal" class="card">Total: R$ 0</div>
  <div class="kpis">
    <div class="kpi"><div class="small">Projetos</div><b id="kpiProj">‚Äì</b></div>
    <div class="kpi"><div class="small">Munic√≠pios</div><b id="kpiMuni">‚Äì</b></div>
    <div class="kpi"><div class="small">Execu√ß√£o m√©dia</div><b id="kpiExec">‚Äì</b></div>
  </div>

  <div class="card">
    <div class="topbar">
      <div>
        <b>Atualiza√ß√£o:</b>
        <select id="selAtual"></select>
        <b>Munic√≠pio:</b>
        <select id="selMuni"><option>Todos</option></select>
      </div>
      <div class="right">
        <button id="resetBtn" class="btn btn-muted">üîÑ Reset filtros</button>
      </div>
    </div>
    <div class="badges" id="badges"></div>
  </div>

  <div class="card">
    <h2>Estrutura Hier√°rquica</h2>
    <div id="hier"></div>
  </div>

  <div class="card"><h2>Tipo de Executor</h2><div id="chartExecutor" class="chart"></div></div>
  <div class="card"><h2>Est√°gio</h2><div id="chartEstagio" class="chart"></div></div>
  <div class="card"><h2>Classifica√ß√£o</h2><div id="chartClassificacao" class="chart"></div></div>

  <div class="card scroll-x"><h2>Eixo</h2><div id="chartEixo" class="chart wide"></div></div>
  <div class="card scroll-x"><h2>Subeixo</h2><div id="chartSubeixo" class="chart wide"></div></div>

  <!-- AGORA HORIZONTAIS + ALTURA DIN√ÇMICA COM ROLAGEM -->
  <div class="card scroll-y"><h2>Modalidade</h2><div id="chartModalidade" class="chart"></div></div>
  <div class="card scroll-y"><h2>Empreendimentos</h2><div id="chartEmp" class="chart"></div></div>

  <div class="small">Clique em qualquer gr√°fico para filtrar; clique novamente para desfazer. Use ‚ÄúReset filtros‚Äù para limpar tudo.</div>
</div>

<script>
// URLs do CSV com fallback
const URLS = [
  "https://raw.githubusercontent.com/lucascunha1979/painel_pac/main/pac_abril_julho_agosto_v1.csv",
  "https://cdn.jsdelivr.net/gh/lucascunha1979/painel_pac@main/pac_abril_julho_agosto_v1.csv",
  "https://raw.githack.com/lucascunha1979/painel_pac/main/pac_abril_julho_agosto_v1.csv"
];

function showError(msg){
  const box = document.getElementById('errorBox');
  box.style.display = 'block';
  box.innerHTML = "‚ö†Ô∏è " + (msg || "Erro inesperado") +
    "<br><span class='small'>Se persistir, verifique se o CSV est√° p√∫blico e o caminho acima est√° correto.</span>";
  console.error(msg);
}

// Helpers
const BRL = n => isFinite(n) ? n.toLocaleString("pt-BR",{style:"currency",currency:"BRL",maximumFractionDigits:0}) : "R$ 0";
const parseMoney = s => parseFloat(String(s||"").replace(/R\\$|\\./g,"").replace(",", "."))||0;
const parsePct   = s => parseFloat(String(s||"").replace("%","").replace(",", "."))||0;
const wrap = (txt, len=22) => String(txt||"").replace(new RegExp(`(?![^\\n]{1,${len}}$)([^\\n]{1,${len}})\\s`,"g"),"$1<br>");
const byUpdateOrder = v => { const x = String(v||"").toLowerCase();
  if (x.includes("abr")) return 1; if (x.includes("jul")) return 2; if (x.includes("ago")) return 3; return 0; };

let RAW = [];
let FILTERS = { Atual:null, Muni:"Todos" };
let DRILL = { Executor:null, Estagio:null, Classificacao:null, Eixo:null, Subeixo:null, Modalidade:null };

// Carrega CSV com fetch + fallbacks
async function loadCSV(){
  for (const base of URLS){
    const url = base + (base.includes("?") ? "&" : "?") + "v=" + Date.now();
    try{
      const res = await fetch(url, {mode:"cors", cache:"no-store"});
      if (!res.ok) throw new Error("HTTP " + res.status + " ao buscar " + base);
      const text = await res.text();
      const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
      if (!parsed.data || parsed.data.length===0){ throw new Error("CSV vazio em " + base); }
      return parsed.data;
    }catch(err){
      console.warn("Falhou:", base, err);
    }
  }
  throw new Error("N√£o foi poss√≠vel baixar o CSV de nenhuma das URLs de fallback.");
}

function initFilters(){
  const u = [...new Set(RAW.map(d=>d.Atual))].sort((a,b)=>byUpdateOrder(a)-byUpdateOrder(b));
  selAtual.innerHTML = u.map(v=>`<option>${v}</option>`).join("");
  FILTERS.Atual = u[u.length-1];
  selAtual.value = FILTERS.Atual;
  selAtual.onchange = e => { FILTERS.Atual = e.target.value; renderAll(); };

  const m = [...new Set(RAW.map(d=>d.Muni))].filter(Boolean).sort();
  m.forEach(v=> selMuni.innerHTML += `<option>${v}</option>`);
  selMuni.onchange = e => { FILTERS.Muni = e.target.value; renderAll(); };

  document.getElementById("resetBtn").onclick = ()=>{ DRILL = { Executor:null, Estagio:null, Classificacao:null, Eixo:null, Subeixo:null, Modalidade:null }; renderAll(); };
  document.getElementById("themeBtn").onclick = ()=>{ document.body.classList.toggle("dark"); };
}

function activeRows(){
  return RAW.filter(r =>
    r.Atual === FILTERS.Atual &&
    (FILTERS.Muni==="Todos" || r.Muni===FILTERS.Muni) &&
    (!DRILL.Executor || r.Executor===DRILL.Executor) &&
    (!DRILL.Estagio || r.Estagio===DRILL.Estagio) &&
    (!DRILL.Classificacao || r.Classificacao===DRILL.Classificacao) &&
    (!DRILL.Eixo || r.Eixo===DRILL.Eixo) &&
    (!DRILL.Subeixo || r.Subeixo===DRILL.Subeixo) &&
    (!DRILL.Modalidade || r.Modalidade===DRILL.Modalidade)
  );
}

function renderBadges(){
  const b = [];
  for (const [k,v] of Object.entries(DRILL)) if (v) b.push(`<span class="badge">${k}: ${v}<span class="x" data-k="${k}">‚úï</span></span>`);
  badges.innerHTML = b.join("") || `<span class="small">Nenhum filtro aplicado.</span>`;
  badges.querySelectorAll(".x").forEach(x=> x.onclick = (e)=>{ const k=e.target.dataset.k; DRILL[k]=null; renderAll(); });
}

function aggWeighted(key){
  const m = {};
  activeRows().forEach(r=>{
    const k = r[key] || "N√£o informado";
    if(!m[k]) m[k]={sum:0, w:0};
    m[k].sum += r.Valor;
    m[k].w   += r.Valor * (r.ExecPct/100);
  });
  return Object.entries(m).map(([k,o])=>({k, v:o.sum, exec: o.sum? (o.w/o.sum*100):0})).sort((a,b)=>b.v-a.v);
}

function renderHierarchyAndKPIs(){
  const f = activeRows();
  const uniq = arr => new Set(arr).size;
  hier.innerHTML = `
    <div class="kpis" style="margin-top:0">
      <div class="kpi"><div class="small">Eixos</div><b>${uniq(f.map(x=>x.Eixo))}</b></div>
      <div class="kpi"><div class="small">Subeixos</div><b>${uniq(f.map(x=>x.Subeixo))}</b></div>
      <div class="kpi"><div class="small">Modalidades</div><b>${uniq(f.map(x=>x.Modalidade))}</b></div>
      <div class="kpi"><div class="small">Empreendimentos</div><b>${uniq(f.map(x=>x.Emp))}</b></div>
    </div>`;
  const total = f.reduce((a,r)=>a+r.Valor,0);
  valorTotal.textContent = `Total: ${BRL(total)}`;
  kpiProj.textContent   = f.length.toLocaleString("pt-BR");
  kpiMuni.textContent   = new Set(f.map(x=>x.Muni)).size.toLocaleString("pt-BR");
  const execMedia = f.length ? f.reduce((a,r)=>a+r.ExecPct,0)/f.length : 0;
  kpiExec.textContent   = `${execMedia.toFixed(1).replace(".",",")}%`;
}

function piePlot(divId, key){
  const a = aggWeighted(key);
  Plotly.newPlot(divId,[{
    labels:a.map(x=>wrap(x.k,20)),
    values:a.map(x=>x.v),
    type:"pie", hole:.25, textinfo:"label+percent",
    hovertemplate:"%{label}<br><b>%{value:,.0f}</b><extra></extra>"
  }],{
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    font:{color:getComputedStyle(document.body).getPropertyValue('--text')},
    legend:{orientation:"h"}
  },{responsive:true});

  const el = document.getElementById(divId);
  el.on('plotly_click', d=>{
    const label = d.points[0].label.replace(/<br>/g," ");
    const cur = DRILL[key];
    DRILL[key] = (cur===label) ? null : label;
    renderAll();
  });
}

// Barras com altura din√¢mica (evita empilhamento)
function barPlot(divId, key, opts={}){
  const a = aggWeighted(key);
  const cfg = Object.assign({horizontal:false, minPitch:22, height:null, sort:true}, opts);
  const container = document.getElementById(divId);

  const count = a.length;
  const pitch = cfg.minPitch; // px por categoria
  const dynHeight = cfg.height || Math.min(3000, Math.max(420, count * pitch));
  container.style.height = dynHeight + "px";

  const x = cfg.horizontal ? a.map(x=>x.v) : a.map(x=>wrap(x.k,22));
  const y = cfg.horizontal ? a.map(x=>wrap(x.k,28)) : a.map(x=>x.v);

  const data = [{
    x, y,
    type:"bar",
    orientation: cfg.horizontal ? "h" : "v",
    marker:{color:getComputedStyle(document.body).getPropertyValue('--accent')},
    customdata: a.map(x=>BRL(x.v)),
    meta: a.map(x=>x.exec.toFixed(1).replace(".",",")),
    hovertemplate: cfg.horizontal
      ? "%{y}<br><b>%{customdata}</b><br>Exec. m√©dia: %{meta}%<extra></extra>"
      : "%{x}<br><b>%{customdata}</b><br>Exec. m√©dia: %{meta}%<extra></extra>",
    cliponaxis:false
  }];

  const layout = {
    paper_bgcolor:"rgba(0,0,0,0)",
    plot_bgcolor:"rgba(0,0,0,0)",
    font:{color:getComputedStyle(document.body).getPropertyValue('--text'), size:12},
    margin: cfg.horizontal ? {l:340,r:30,t:10,b:40} : {l:60,r:30,t:10,b:170},
    xaxis: {
      automargin:true,
      tickangle: cfg.horizontal ? 0 : -35,
      tickfont:{size:12},
      categoryorder: cfg.sort ? (cfg.horizontal ? "total ascending" : "total descending") : "trace"
    },
    yaxis: {
      automargin:true,
      tickfont:{size:12},
      tickformat:",.0f",
      categoryorder: cfg.sort ? (cfg.horizontal ? "total ascending" : "total descending") : "trace"
    }
  };

  Plotly.newPlot(divId, data, layout, {responsive:true});

  const el = document.getElementById(divId);
  el.on('plotly_click', d=>{
    const label = cfg.horizontal ? d.points[0].y : d.points[0].x;
    const plain = String(label).replace(/<br>/g," ");
    const cur = DRILL[key];
    DRILL[key] = (cur===plain) ? null : plain;
    renderAll();
  });
}

function renderAll(){
  renderHierarchyAndKPIs();
  renderBadges();
  piePlot("chartExecutor","Executor");
  piePlot("chartEstagio","Estagio");
  barPlot("chartClassificacao","Classificacao",{horizontal:false});
  barPlot("chartEixo","Eixo",{horizontal:false, minPitch:28});
  barPlot("chartSubeixo","Subeixo",{horizontal:false, minPitch:28});
  // HORIZONTAIS com altura din√¢mica ‚Üí r√≥tulos leg√≠veis + rolagem
  barPlot("chartModalidade","Modalidade",{horizontal:true, minPitch:26});
  barPlot("chartEmp","Emp",{horizontal:true, minPitch:26});
}

// PDF paginado robusto (capa + se√ß√µes)
document.getElementById("pdfBtn").onclick = async ()=>{
  try{
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("l","pt","a4");
    const bg = getComputedStyle(document.body).getPropertyValue('--bg');
    const fg = getComputedStyle(document.body).getPropertyValue('--text');

    const capture = async (node) => {
      const canvas = await html2canvas(node,{scale:2, useCORS:true, backgroundColor:bg});
      const img = canvas.toDataURL("image/png");
      const pw = pdf.internal.pageSize.getWidth();
      const ph = pdf.internal.pageSize.getHeight();
      const ratio = Math.min(pw/canvas.width, ph/canvas.height);
      const w = canvas.width * ratio;
      const h = canvas.height * ratio;
      return {img,w,h,pw,ph};
    };

    // Capa
    const cover = document.createElement("div");
    cover.style.padding="24px"; cover.style.background=bg; cover.style.color=fg;
    cover.innerHTML = `<h1 style="margin:0 0 8px 0">Painel do Novo PAC ‚Äì RS</h1>
    <div>Fonte: Novo PAC ‚Äì Casa Civil ‚Äì Governo Federal ‚Äî Atualiza√ß√£o Agosto/2025</div>
    <div style="margin-top:10px">Atualiza√ß√£o: <b>${selAtual.value}</b> ‚Ä¢ Munic√≠pio: <b>${selMuni.value}</b></div>`;
    {
      const {img,w,h,pw,ph} = await capture(cover);
      pdf.addImage(img,"PNG",(pw-w)/2,(ph-h)/2,w,h);
    }

    const sections = [
      document.getElementById("valorTotal"),
      document.querySelector(".kpis"),
      document.getElementById("hier"),
      document.getElementById("chartExecutor").parentElement,
      document.getElementById("chartEstagio").parentElement,
      document.getElementById("chartClassificacao").parentElement,
      document.getElementById("chartEixo").parentElement,
      document.getElementById("chartSubeixo").parentElement,
      document.getElementById("chartModalidade").parentElement,
      document.getElementById("chartEmp").parentElement
    ];

    for (let i=0;i<sections.length;i++){
      try{
        const sec = sections[i];
        const {img,w,h,pw,ph} = await capture(sec);
        pdf.addPage();
        pdf.addImage(img,"PNG",(pw-w)/2,(ph-h)/2,w,h);
      }catch(e){
        console.warn("Falha ao capturar se√ß√£o", i, e);
      }
    }
    pdf.save("Painel_PAC_RS.pdf");
  }catch(err){
    console.error(err);
    showError("Falha ao gerar o PDF. Detalhe: " + (err && err.message ? err.message : String(err)));
  }
};

// Boot
(async ()=>{
  try{
    const rows = await loadCSV();
    RAW = rows.map(r=>({
      Atual: r["Atualiza√ß√£o"]||r["Atualizacao"]||"",
      Muni:  r["Munic√≠pio"]||r["Municipio"]||"",
      Executor: r["Tipo de Executor"]||"",
      Estagio:   r["Est√°gio"]||r["Estagio"]||"",
      Classificacao: r["Classifica√ß√£o"]||r["Classificacao"]||"",
      Eixo: r["Eixo"]||"",
      Subeixo: r["Subeixo"]||"",
      Modalidade: r["Modalidade"]||"",
      Emp: r["Empreendimento"]||"",
      Valor:   parseMoney(r["Estimativa do valor total do empreendimento no Novo PAC (2023-2030) (R$)"]),
      ExecPct: parsePct(r["Percentual de execu√ß√£o do empreendimento (%)"])
    })).filter(r=>r.Atual && r.Eixo);
    initFilters();
    renderAll();
  }catch(err){
    showError("Erro ao carregar CSV: " + (err && err.message ? err.message : String(err)));
  }
})();
</script>
</body>
</html>