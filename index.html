<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel Novo PAC ‚Äì Rio Grande do Sul</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{
    --bg:#0a0a0a; --panel:#1a1a1a; --red:#ef4444; --muted:#cccccc;
  }
  *{box-sizing:border-box}
  body{background:var(--bg);color:#fff;font-family:Arial,Helvetica,sans-serif; margin:0;padding:18px}
  h1{margin:0 0 6px 0;font-size:26px}
  h2{color:var(--red);margin:0 0 10px 0;font-size:20px}
  .meta{color:var(--muted);margin-bottom:14px}
  .wrap{max-width:1400px;margin:auto}
  .card{background:var(--panel);border:1px solid #222;border-radius:12px;padding:16px;margin:0 0 18px 0}
  .filters select{padding:8px 10px;background:#000;border:1px solid #555;color:#fff;border-radius:8px;margin-right:10px}
  .chart{height:420px}
  #valorTotal{background:var(--red);border-radius:12px;padding:14px;text-align:center;font-size:30px;font-weight:bold;margin-bottom:18px}
  .hier-box{display:flex;justify-content:center;gap:16px;flex-wrap:wrap;margin:8px 0}
  .hitem{background:#f5f5d8;color:#000;border:1px solid #aaa;border-radius:10px;min-width:170px;padding:10px 14px;font-weight:bold;text-align:center}
  .hitem.blue{background:#b7d8eb}
  .arrow{width:100%;text-align:center;color:#fff;margin:2px 0 6px 0}
  .row{display:flex;gap:18px;flex-wrap:wrap}
  .col{flex:1 1 480px}
  .scroll-x{overflow-x:auto}
  .chart.wide{width:1400px}
  .chart.wider{width:2000px}
  #btnPDF{position:fixed;right:18px;bottom:18px;background:var(--red);color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,.35)}
</style>
</head>
<body>
<div class="wrap">

  <h1>Painel do Novo PAC ‚Äì RS</h1>
  <div class="meta">Fonte: Novo PAC ‚Äì Casa Civil ‚Äì Governo Federal ‚Äî Atualiza√ß√£o Agosto/2025</div>

  <div id="valorTotal">Total: R$ 0</div>

  <div class="card">
    <div class="filters">
      <b>Atualiza√ß√£o:</b>
      <select id="selAtual"></select>
      <b style="margin-left:10px">Munic√≠pio:</b>
      <select id="selMuni">
        <option>Todos</option>
      </select>
    </div>
  </div>

  <div class="card">
    <h2>Estrutura Hier√°rquica do Novo PAC</h2>
    <div id="hier">
      <!-- preenchido por JS -->
    </div>
  </div>

  <div class="row">
    <div class="card col">
      <h2>Tipo de Executor</h2>
      <div id="chartExecutor" class="chart"></div>
    </div>
    <div class="card col">
      <h2>Est√°gio</h2>
      <div id="chartEstagio" class="chart"></div>
    </div>
  </div>

  <div class="card">
    <h2>Classifica√ß√£o</h2>
    <div id="chartClassificacao" class="chart"></div>
  </div>

  <div class="card scroll-x">
    <h2>Eixo</h2>
    <div id="chartEixo" class="chart wide"></div>
  </div>

  <div class="row">
    <div class="card col scroll-x">
      <h2>Subeixo</h2>
      <div id="chartSubeixo" class="chart wide"></div>
    </div>
    <div class="card col scroll-x">
      <h2>Modalidade</h2>
      <div id="chartModalidade" class="chart wide"></div>
    </div>
  </div>

  <div class="card scroll-x">
    <h2>Empreendimentos</h2>
    <div id="chartEmp" class="chart wider"></div>
  </div>

  <button id="btnPDF">üìÑ Baixar PDF</button>

</div>

<script>
const CSV_FILE = "https://raw.githubusercontent.com/lucascunha1979/painel-pac/main/pac_abril_julho_agosto_v1.csv";

let raw = [];
let filters = { Atualizacao: null, Municipio: "Todos" };

// =============== Utilidades ===============
const fmtBR = (n) => {
  if (!isFinite(n)) return "R$ 0";
  if (n >= 1e9) return "R$ " + (n/1e9).toFixed(2).replace(".", ",") + " bi";
  if (n >= 1e6) return "R$ " + (n/1e6).toFixed(2).replace(".", ",") + " mi";
  if (n >= 1e3) return "R$ " + n.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, "."); 
  return "R$ " + n.toFixed(0).replace(".", ",");
};

const parseMoney = (s) => {
  if (s == null) return 0;
  return parseFloat((String(s)).replace(/R\$|\s|\./g, "").replace(",", ".")) || 0;
};
const parsePct = (s) => {
  if (s == null) return 0;
  return parseFloat((String(s)).replace("%","").replace(",", ".")) || 0;
};

// M√©dia ponderada de execu√ß√£o por Valor
function aggWeightedExec(rows, key){
  const map = {};
  rows.forEach(r=>{
    const k = r[key] || "N√£o informado";
    if (!map[k]) map[k] = {sumValor:0, sumPesoExec:0};
    map[k].sumValor += r.Valor;
    map[k].sumPesoExec += r.Valor * r.Exec/100.0;
  });
  return Object.entries(map).map(([k, obj])=>{
    const media = obj.sumValor>0 ? (obj.sumPesoExec/obj.sumValor)*100 : 0;
    return {k, valor: obj.sumValor, exec: media};
  }).sort((a,b)=>b.valor-a.valor);
}

function filtered(){
  return raw.filter(r =>
    (filters.Atualizacao==null || r.Atualizacao===filters.Atualizacao) &&
    (filters.Municipio==="Todos" || r.Municipio===filters.Municipio)
  );
}

// =============== Carga do CSV ===============
Papa.parse(CSV_FILE, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: (res) => {
    if (res.errors.length > 0) {
      console.error("Erros no parse:", res.errors);
    }
    
    raw = res.data
      .filter(row => row && Object.keys(row).length > 0) // Remove linhas vazias
      .map(r => {
        return {
          Atualizacao: r["Atualiza√ß√£o"] || r["Atualizacao"] || "N/A",
          Municipio: r["Munic√≠pio"] || r["Municipio"] || "N/A",
          Executor: r["Tipo de Executor"] || r["Executor"] || "N/A",
          Estagio: r["Est√°gio"] || r["Estagio"] || "N/A",
          Classificacao: r["Classifica√ß√£o"] || r["Classificacao"] || "N/A",
          Eixo: r["Eixo"] || "N/A",
          Subeixo: r["Subeixo"] || "N/A",
          Modalidade: r["Modalidade"] || "N/A",
          Emp: r["Empreendimento"] || r["Emp"] || "N/A",
          Valor: parseMoney(r["Estimativa do valor total do empreendimento no Novo PAC (2023-2030) (R$)"] || r["Valor"] || 0),
          Exec: parsePct(r["Percentual de execu√ß√£o do empreendimento (%)"] || r["Exec"] || 0)
        };
      });

    console.log(`${raw.length} registros processados`);
    
    if (raw.length === 0) {
      alert("Nenhum dado foi carregado. Verifique a estrutura do CSV.");
      return;
    }
    
    initFilters();
    renderAll();
  },
  error: (err) => {
    console.error("Falha ao carregar arquivo:", err);
    alert(`Erro ao carregar CSV: ${err.message}`);
  }
});

// =============== Filtros ===============
function initFilters(){
  // Atualiza√ß√£o (SEM "Todos")
  const u = [...new Set(raw.map(d=>d.Atualizacao))].filter(x=>x!=null && x!="N/A");
  u.sort();
  const selAtual = document.getElementById("selAtual");
  selAtual.innerHTML = u.map(v=>`<option>${v}</option>`).join("");
  filters.Atualizacao = u[u.length-1]; // come√ßa na mais recente
  selAtual.value = filters.Atualizacao;
  selAtual.onchange = (e)=>{ filters.Atualizacao = e.target.value; renderAll(); };

  // Munic√≠pio (com "Todos")
  const m = [...new Set(raw.map(d=>d.Municipio))].filter(x=>x!=null && x!="N/A").sort();
  const selMuni = document.getElementById("selMuni");
  m.forEach(v => selMuni.innerHTML += `<option>${v}</option>`);
  selMuni.onchange = (e)=>{ filters.Municipio = e.target.value; renderAll(); };
}

// =============== Hierarquia & Card ===============
function renderHierarchy(){
  const f = filtered();
  const uniq = (arr) => new Set(arr).size;

  const html = `
    <div class="hier-box"><div class="hitem">üß≠ Eixos<br><b>${uniq(f.map(x=>x.Eixo))}</b></div></div>
    <div class="arrow">‚Üì</div>
    <div class="hier-box"><div class="hitem">üîÅ Subeixos<br><b>${uniq(f.map(x=>x.Subeixo))}</b></div></div>
    <div class="arrow">‚Üì</div>
    <div class="hier-box"><div class="hitem">üì¶ Modalidades<br><b>${uniq(f.map(x=>x.Modalidade))}</b></div></div>
    <div class="arrow">‚Üì</div>
    <div class="hier-box"><div class="hitem blue">üèóÔ∏è Empreendimentos<br><b>${uniq(f.map(x=>x.Emp))}</b></div></div>
    <div class="arrow">‚Üì</div>
    <div class="hier-box">
      <div class="hitem">üè∑Ô∏è Classifica√ß√£o<br><b>${uniq(f.map(x=>x.Classificacao))}</b></div>
      <div class="hitem">üöß Est√°gio<br><b>${uniq(f.map(x=>x.Estagio))}</b></div>
      <div class="hitem">üèõÔ∏è Executor<br><b>${uniq(f.map(x=>x.Executor))}</b></div>
    </div>
  `;
  document.getElementById("hier").innerHTML = html;

  const total = f.reduce((acc, r)=>acc+r.Valor, 0);
  document.getElementById("valorTotal").innerText = "Total: " + fmtBR(total);
}

// =============== Gr√°ficos ===============
function pieChart(id, key){
  const a = aggWeightedExec(filtered(), key);
  Plotly.newPlot(id, [{
    labels: a.map(x=>x.k),
    values: a.map(x=>x.valor),
    type: "pie",
    textinfo: "label+percent",
    hole: 0.25,
    hovertemplate: "%{label}<br><b>"+a.map(x=>fmtBR(x.valor))+
      "</b><br>M√©dia exec.: "+a.map(x=>x.exec.toFixed(1).replace(".",","))+"%<extra></extra>"
  }], {
    paper_bgcolor:"#0a0a0a", plot_bgcolor:"#0a0a0a",
    font:{color:"#fff"}, legend:{x:0.85, y:0.5}
  }, {responsive:true});
}

function barChart(id, key){
  const a = aggWeightedExec(filtered(), key);
  Plotly.newPlot(id, [{
    x: a.map(x=>x.k), y: a.map(x=>x.valor),
    type: "bar", marker:{color:"#ef4444"},
    hovertemplate: "%{x}<br><b>%{customdata}</b><br>M√©dia exec.: %{meta}%%<extra></extra>",
    customdata: a.map(x=>fmtBR(x.valor)),
    meta: a.map(x=>x.exec.toFixed(1).replace(".",","))
  }], {
    paper_bgcolor:"#0a0a0a", plot_bgcolor:"#0a0a0a", font:{color:"#fff"},
    margin:{b:130}, xaxis:{tickangle:-30}, yaxis:{tickformat:",.0f"}
  }, {responsive:true});
}

function barChartWide(id, key, widthClass="wide"){
  document.getElementById(id).classList.add(widthClass);
  barChart(id, key);
}

function barChartH(id, key){
  const a = aggWeightedExec(filtered(), key);
  Plotly.newPlot(id, [{
    x: a.map(x=>x.valor), y: a.map(x=>x.k),
    type:"bar", orientation:"h", marker:{color:"#ef4444"},
    hovertemplate: "%{y}<br><b>%{customdata}</b><br>M√©dia exec.: %{meta}%%<extra></extra>",
    customdata: a.map(x=>fmtBR(x.valor)),
    meta: a.map(x=>x.exec.toFixed(1).replace(".",","))
  }], {
    paper_bgcolor:"#0a0a0a", plot_bgcolor:"#0a0a0a", font:{color:"#fff"},
    margin:{l:240}, xaxis:{tickformat:",.0f"}
  }, {responsive:true});
}

// =============== Render ===============
function renderAll(){
  renderHierarchy();
  pieChart("chartExecutor","Executor");
  pieChart("chartEstagio","Estagio");
  barChart("chartClassificacao","Classificacao");
  barChartWide("chartEixo","Eixo","wide");
  barChartWide("chartSubeixo","Subeixo","wide");
  barChartWide("chartModalidade","Modalidade","wide");
  barChartH("chartEmp","Emp");
}

// =============== PDF ===============
document.getElementById("btnPDF").onclick = async ()=>{
  const { jsPDF } = window.jspdf;
  const node = document.querySelector(".wrap");
  const canvas = await html2canvas(node, {scale:2, useCORS:true, backgroundColor:"#0a0a0a"});
  const img = canvas.toDataURL("image/png");
  const pdf = new jsPDF("l","pt","a4");
  // Ajuste para preencher p√°gina mantendo propor√ß√£o
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  pdf.addImage(img, "PNG", 0, 0, pageW, pageH);
  pdf.save("relatorio_pac.pdf");
};
</script>
</body>
</html>