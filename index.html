<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel do Novo PAC â€“ Rio Grande do Sul</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --bg: #0a0a0a; --panel:#1b1b1b; --text:#ffffff; --accent:#ef4444;
}
.light {
  --bg:#ffffff; --panel:#f1f1f1; --text:#000000; --accent:#b91c1c;
}
body{background:var(--bg);color:var(--text);font-family:Arial;margin:0;padding:18px;}
.wrap{max-width:1500px;margin:auto}
h1{margin:0;font-size:26px}
h2{margin:0 0 10px;font-size:20px;color:var(--accent)}
.card{background:var(--panel);padding:15px;border-radius:10px;margin-bottom:18px;border:1px solid #333;}
select{padding:6px;background:var(--bg);color:var(--text);border:1px solid #666;border-radius:6px;margin-right:10px;}
button{cursor:pointer}
#valorTotal{background:var(--accent);color:white;padding:12px;font-size:26px;text-align:center;border-radius:10px;margin-bottom:15px}
.chart{height:380px}
.scroll-x{overflow-x:auto}
.wide{width:1600px}
#themeToggle{position:fixed;top:10px;right:10px;padding:6px 12px;background:var(--accent);border:0;border-radius:8px;color:white;font-weight:bold}
#resetBtn{padding:6px 12px;background:gray;border:0;border-radius:8px;color:white;margin-left:10px}
#pdfBtn{position:fixed;bottom:10px;right:10px;padding:8px 14px;background:var(--accent);border:0;border-radius:8px;color:white;font-weight:bold}
</style>
</head>
<body>
<button id="themeToggle">ðŸŒ™</button>
<div class="wrap">
<h1>Painel do Novo PAC â€“ Rio Grande do Sul</h1>
<p>Fonte: Novo PAC â€“ Casa Civil â€“ Governo Federal â€” AtualizaÃ§Ã£o Agosto/2025</p>
<div id="valorTotal">Total: R$ 0</div>

<div class="card">
<b>AtualizaÃ§Ã£o:</b> <select id="selAtual"></select>
<b>MunicÃ­pio:</b> <select id="selMuni"><option>Todos</option></select>
<button id="resetBtn">ðŸ”„ Resetar filtros</button>
</div>

<div class="card"><h2>Hierarquia (Eixo > Subeixo > Modalidade > Empreendimento)</h2>
<div id="hier"></div></div>

<div class="card"><h2>Tipo de Executor</h2><div id="exec" class="chart"></div></div>
<div class="card"><h2>EstÃ¡gio</h2><div id="est" class="chart"></div></div>
<div class="card"><h2>ClassificaÃ§Ã£o</h2><div id="class" class="chart"></div></div>

<div class="card scroll-x"><h2>Eixo</h2><div id="eixo" class="chart wide"></div></div>
<div class="card scroll-x"><h2>Subeixo</h2><div id="sub" class="chart wide"></div></div>
<div class="card scroll-x"><h2>Modalidade</h2><div id="mod" class="chart wide"></div></div>
<div class="card scroll-x"><h2>Empreendimentos</h2><div id="emp" class="chart wide"></div></div>
</div>

<button id="pdfBtn">ðŸ“„ PDF</button>

<script>
const CSV_FILE="https://raw.githack.com/lucascunha1979/painel_pac/main/pac_abril_julho_agosto_v1.csv";
let raw=[],filters={Atual:null,Muni:"Todos"};
let drill={Eixo:null,Subeixo:null,Modalidade:null};

function wrap(s){return String(s).replace(/(.{18})/g,"$1<br>");}
function money(v){if(v>=1e9)return"R$ "+(v/1e9).toFixed(2)+" bi";if(v>=1e6)return"R$ "+(v/1e6).toFixed(2)+" mi";return"R$ "+v.toFixed(0);}
function parseM(s){return parseFloat((s||"").replace(/R\\$|\\./g,"").replace(",","."))||0;}
function parseP(s){return parseFloat((s||"").replace("%","").replace(",", "."))||0;}

Papa.parse(CSV_FILE,{download:true,header:true,complete:(res)=>{
 raw=res.data.map(r=>({
  Atual:r["AtualizaÃ§Ã£o"],Muni:r["MunicÃ­pio"],
  Exec:r["Tipo de Executor"],Est:r["EstÃ¡gio"],Class:r["ClassificaÃ§Ã£o"],
  Eixo:r["Eixo"],Sub:r["Subeixo"],Mod:r["Modalidade"],Emp:r["Empreendimento"],
  Valor:parseM(r["Estimativa do valor total do empreendimento no Novo PAC (2023-2030) (R$)"]),
  ExecPct:parseP(r["Percentual de execuÃ§Ã£o do empreendimento (%)"])
 }));
 initFilters();renderAll();
}});

function initFilters(){
 let u=[...new Set(raw.map(x=>x.Atual))].filter(Boolean).sort();
 selAtual.innerHTML=u.map(x=>`<option>${x}</option>`).join("");filters.Atual=u[u.length-1];
 selAtual.value=filters.Atual;selAtual.onchange=e=>{filters.Atual=e.target.value;renderAll();}
 let m=[...new Set(raw.map(x=>x.Muni))].filter(Boolean).sort();
 m.forEach(x=>selMuni.innerHTML+=`<option>${x}</option>`);selMuni.onchange=e=>{filters.Muni=e.target.value;renderAll();}
}

function subset(){
return raw.filter(r=>
 r.Atual===filters.Atual &&
 (filters.Muni==="Todos"||r.Muni===filters.Muni) &&
 (!drill.Eixo||r.Eixo===drill.Eixo) &&
 (!drill.Subeixo||r.Sub===drill.Subeixo) &&
 (!drill.Modalidade||r.Mod===drill.Modalidade)
);
}

function agg(col){
 let m={},s=subset();
 s.forEach(r=>{
  let k=r[col]||"NÃ£o informado";
  if(!m[k])m[k]={v:0,w:0};
  m[k].v+=r.Valor;m[k].w+=r.Valor*r.ExecPct/100;
 });
 return Object.entries(m).map(([k,x])=>({k,v:x.v,exec:(x.v? (x.w/x.v*100):0)})).sort((a,b)=>b.v-a.v);
}

function hier(){
 let s=subset();
 let h=`<b>Eixos:</b> ${new Set(s.map(x=>x.Eixo)).size} â†’ 
<b>Subeixos:</b> ${new Set(s.map(x=>x.Sub)).size} â†’ 
<b>Modalidades:</b> ${new Set(s.map(x=>x.Mod)).size} â†’ 
<b>Empreendimentos:</b> ${new Set(s.map(x=>x.Emp)).size}`;
 hier.innerHTML=h;
 valorTotal.innerText="Total: "+money(s.reduce((a,r)=>a+r.Valor,0));
}

function bar(id,col,drillKey){
 let a=agg(col);
 Plotly.newPlot(id,[{x:a.map(x=>wrap(x.k)),y:a.map(x=>x.v),type:"bar",
 marker:{color:"#ef4444"},
 customdata:a.map(x=>money(x.v)),meta:a.map(x=>x.exec.toFixed(1)+"%"),
 hovertemplate:"%{x}<br><b>%{customdata}</b><br>MÃ©dia Exec: %{meta}<extra></extra>"
 }],{paper_bgcolor:"transparent",plot_bgcolor:"transparent",
 font:{color:"var(--text)"},margin:{b:130},xaxis:{tickangle:-30}});

 let plot=document.getElementById(id);
 plot.on("plotly_click",d=>{drill[drillKey]=d.points[0].x.replace(/<br>/g," ").replace(/(.{18})/g,"");renderAll();});
}

function pie(id,col){
 let a=agg(col);
 Plotly.newPlot(id,[{labels:a.map(x=>wrap(x.k)),values:a.map(x=>x.v),type:"pie",
 textinfo:"label+percent",
 hovertemplate:"%{label}<br><b>%{value}</b><extra></extra>"
 }],{paper_bgcolor:"transparent",plot_bgcolor:"transparent",font:{color:"var(--text)"}});

 let p=document.getElementById(id);
 p.on("plotly_click",d=>{drill[col]=d.points[0].label.replace(/<br>/g," ");renderAll();});
}

function renderAll(){
 hier();
 bar("exec","Exec","Executor");
 bar("est","Est","Estagio");
 bar("class","Class","Classificacao");
 bar("eixo","Eixo","Eixo");
 bar("sub","Sub","Subeixo");
 bar("mod","Mod","Modalidade");
 bar("emp","Emp","Emp");
}

resetBtn.onclick=()=>{drill={Eixo:null,Subeixo:null,Modalidade:null};renderAll();};
themeToggle.onclick=()=>{document.body.classList.toggle("light");};

pdfBtn.onclick=async()=>{
 const { jsPDF }=window.jspdf;let pdf=new jsPDF("l","pt","a4");
 let node=document.body;let canvas=await html2canvas(node,{scale:2});
 let img=canvas.toDataURL("image/png");let w=pdf.internal.pageSize.getWidth();
 let h=pdf.internal.pageSize.getHeight();pdf.addImage(img,"PNG",0,0,w,h);
 pdf.save("painel_pac.pdf");
};
</script>
</body>
</html>