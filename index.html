<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel do Novo PAC ‚Äì Rio Grande do Sul</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<!-- PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<!-- html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root{ --bg:#ffffff; --panel:#f4f5f7; --text:#111; --muted:#555; --accent:#e11d2e; }
*{box-sizing:border-box}
body{margin:0;padding:18px;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
.wrap{max-width:1500px;margin:0 auto}
h1{margin:0 0 6px;font-size:26px}
h2{margin:0 0 10px;font-size:20px;color:var(--accent)}
.meta{color:var(--muted);margin-bottom:10px}
.card{background:var(--panel);border:1px solid #d6d7da;border-radius:12px;padding:16px;margin:0 0 18px}
select{padding:8px 10px;border:1px solid #b9bdc0;border-radius:8px;background:var(--bg);color:var(--text);margin-right:10px}
.btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
.btn-accent{background:var(--accent);color:#fff}
.btn-muted{background:#999;color:#fff}
.topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto;display:flex;gap:8px}
#valorTotal{background:var(--accent);color:#fff;padding:14px;border-radius:12px;text-align:center;font-size:28px;font-weight:700}
.kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpi{background:var(--panel);border:1px solid #d6d7da;border-radius:10px;padding:10px 12px;min-width:180px}
.kpi b{display:block;font-size:18px;margin-top:4px}
.small{font-size:12px;color:var(--muted)}
.badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.badge{background:#e8eaed;color:#111;border-radius:20px;padding:4px 10px;font-size:12px;border:1px solid #cfd1d4}
.badge .x{margin-left:6px;cursor:pointer}

/* gr√°ficos */
.chart{height:440px}
.chart-v{overflow-x:auto}
.chart-h{height:560px; overflow-y:auto}

/* TABELAS para PDF */
#tables{display:none}
#tables.show{display:block}
#tables h2{color:#000;margin:16px 0 8px}
table.report{border-collapse:collapse;width:100%;font-size:11px}
table.report th, table.report td{border:1px solid #bbb;padding:6px;text-align:left;vertical-align:top}
table.report th{background:#efefef}
tfoot td{font-weight:700;background:#fafafa}
.source{margin-top:10px;color:#333;font-size:11px}
</style>
</head>
<body>
<div class="wrap" id="app">

  <div class="topbar">
    <div>
      <h1>Painel do Novo PAC ‚Äì Rio Grande do Sul</h1>
      <div class="meta">Fonte: Novo PAC (2023-2030) ‚Äì Casa Civil, Governo Federal ‚Äî atualiza√ß√£o: Ago/2025</div>
    </div>
    <div class="right">
      <button id="btnPdf" class="btn btn-accent" title="Baixar PDF com tabelas">üìÑ PDF (tabelas)</button>
    </div>
  </div>

  <div id="valorTotal">Total: R$ 0,00</div>
  <div class="kpis">
    <div class="kpi"><div class="small">Empreendimentos</div><b id="kpiProj">‚Äì</b></div>
    <div class="kpi"><div class="small">Munic√≠pios</div><b id="kpiMuni">‚Äì</b></div>
    <div class="kpi"><div class="small">Execu√ß√£o m√©dia</div><b id="kpiExec">‚Äì</b></div>
  </div>

  <div class="card">
    <div class="topbar">
      <div>
        <b>Atualiza√ß√£o:</b>
        <select id="selAtual"></select>
        <b>Munic√≠pio:</b>
        <select id="selMuni"><option>Todos</option></select>
      </div>
      <div class="right">
        <button id="btnReset" class="btn btn-muted">üîÑ Reset filtros</button>
      </div>
    </div>
    <div class="badges" id="badges"></div>
  </div>

  <div class="card">
    <h2>Estrutura Hier√°rquica</h2>
    <div id="hier"></div>
  </div>

  <div class="card"><h2>Tipo de Executor</h2><div id="chartExecutor" class="chart chart-v"></div></div>
  <div class="card"><h2>Est√°gio</h2><div id="chartEstagio" class="chart chart-v"></div></div>
  <div class="card"><h2>Classifica√ß√£o</h2><div id="chartClassificacao" class="chart chart-v"></div></div>
  <div class="card"><h2>Eixo</h2><div id="chartEixo" class="chart chart-v"></div></div>
  <div class="card"><h2>Subeixo</h2><div id="chartSubeixo" class="chart chart-h"></div></div>
  <div class="card"><h2>Modalidade</h2><div id="chartModalidade" class="chart chart-h"></div></div>
  <div class="card"><h2>Empreendimentos</h2><div id="chartEmp" class="chart chart-h"></div></div>

  <div class="small">Clique em qualquer gr√°fico para filtrar; clique novamente para desfazer. ‚ÄúReset filtros‚Äù limpa tudo.</div>

  <!-- Tabelas para PDF -->
  <div id="tables"></div>

</div>

<script>
const CSV_FILE = "https://raw.githack.com/lucascunha1979/painel_pac/main/pac_abril_julho_agosto_v1.csv";

const nfBR2 = new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:2,maximumFractionDigits:2});
const BRL = v => nfBR2.format(Math.round((v + Number.EPSILON)*100)/100);
const pct1  = v => (isFinite(v)? (v.toFixed(1).replace(".",",")) : "0,0");
function parseMoneyBR(s){
  if (s==null) return 0;
  const t = String(s).replace(/\s|R\$/g,"").replace(/\./g,"").replace(",",".").trim();
  const n = parseFloat(t);
  return isFinite(n) ? n : 0;
}
function parsePctBR(s){
  if (s==null) return NaN;
  const t = String(s).replace("%","").replace(",",".").trim();
  const n = parseFloat(t);
  return isFinite(n) ? n : NaN;
}
const ellips = (txt, len=42) => {
  const s = String(txt||"");
  return s.length>len ? s.slice(0,len-1)+"‚Ä¶" : s;
};

let RAW=[], FILTERS={Atual:null, Muni:"Todos"}, DRILL={Executor:null, Estagio:null, Classificacao:null, Eixo:null, Subeixo:null, Modalidade:null};

Papa.parse(CSV_FILE,{
  download:true, header:true, skipEmptyLines:true,
  complete:(res)=>{
    RAW = res.data.map(r=>({
      Atual:  r["Atualiza√ß√£o"]||r["Atualizacao"]||"",
      Muni:   r["Munic√≠pio"]||r["Municipio"]||"",
      Executor: r["Tipo de Executor"]||"",
      Estagio:  r["Est√°gio"]||r["Estagio"]||"",
      Classificacao: r["Classifica√ß√£o"]||r["Classificacao"]||"",
      Eixo: r["Eixo"]||"",
      Subeixo: r["Subeixo"]||"",
      Modalidade: r["Modalidade"]||"",
      Emp: r["Empreendimento"]||"",
      Valor: parseMoneyBR(r["Estimativa do valor total do empreendimento no Novo PAC (2023-2030) (R$)"]),
      ExecPct: parsePctBR(r["Percentual de execu√ß√£o do empreendimento (%)"])
    })).filter(r=>r.Atual && r.Eixo);
    initFilters();
    renderAll();
  },
  error:(e)=>alert("Erro ao carregar CSV: "+e.message)
});

function byUpdateOrder(v){
  const x = String(v||"").toLowerCase();
  if (x.includes("abr")) return 1;
  if (x.includes("jul")) return 2;
  if (x.includes("ago")) return 3;
  return 0;
}
function initFilters(){
  const u = [...new Set(RAW.map(d=>d.Atual))].sort((a,b)=>byUpdateOrder(a)-byUpdateOrder(b));
  selAtual.innerHTML = u.map(v=>`<option>${v}</option>`).join("");
  FILTERS.Atual = u[u.length-1];
  selAtual.value = FILTERS.Atual;
  selAtual.onchange = e=>{ FILTERS.Atual=e.target.value; renderAll(); };

  const m = [...new Set(RAW.map(d=>d.Muni))].filter(Boolean).sort();
  m.forEach(v=> selMuni.innerHTML += `<option>${v}</option>`);
  selMuni.onchange = e=>{ FILTERS.Muni=e.target.value; renderAll(); };

  btnReset.onclick = ()=>{ DRILL={Executor:null, Estagio:null, Classificacao:null, Eixo:null, Subeixo:null, Modalidade:null}; renderAll(); };
  btnPdf.onclick   = ()=> makePDF();
}

function actRows(){
  return RAW.filter(r=>
    r.Atual===FILTERS.Atual &&
    (FILTERS.Muni==="Todos" || r.Muni===FILTERS.Muni) &&
    (!DRILL.Executor || r.Executor===DRILL.Executor) &&
    (!DRILL.Estagio || r.Estagio===DRILL.Estagio) &&
    (!DRILL.Classificacao || r.Classificacao===DRILL.Classificacao) &&
    (!DRILL.Eixo || r.Eixo===DRILL.Eixo) &&
    (!DRILL.Subeixo || r.Subeixo===DRILL.Subeixo) &&
    (!DRILL.Modalidade || r.Modalidade===DRILL.Modalidade)
  );
}

function renderBadges(){
  const b=[];
  for (const [k,v] of Object.entries(DRILL)) if (v) b.push(`<span class="badge">${k}: ${v}<span class="x" data-k="${k}">‚úï</span></span>`);
  badges.innerHTML = b.length? b.join("") : `<span class="small">Nenhum filtro aplicado.</span>`;
  badges.querySelectorAll(".x").forEach(x=> x.onclick=(e)=>{ const k=e.target.dataset.k; DRILL[k]=null; renderAll(); });
}

function aggSimple(key){
  const m={};
  actRows().forEach(r=>{
    const k = r[key] || "N√£o informado";
    if(!m[k]) m[k]={sumVal:0, n:0, pctVals:[]};
    m[k].sumVal += r.Valor;
    m[k].n += 1;
    if (isFinite(r.ExecPct)) m[k].pctVals.push(r.ExecPct);
  });
  return Object.entries(m).map(([k,o])=>{
    const exec = o.pctVals.length ? o.pctVals.reduce((a,b)=>a+b,0)/o.pctVals.length : 0;
    return {k, v:o.sumVal, n:o.n, exec};
  }).sort((a,b)=>b.v-a.v);
}

function renderHierarchyAndKPIs(){
  const f = actRows();
  const uniq = arr => new Set(arr).size;
  hier.innerHTML = `
    <div class="kpis" style="margin-top:0">
      <div class="kpi"><div class="small">Eixos</div><b>${uniq(f.map(x=>x.Eixo))}</b></div>
      <div class="kpi"><div class="small">Subeixos</div><b>${uniq(f.map(x=>x.Subeixo))}</b></div>
      <div class="kpi"><div class="small">Modalidades</div><b>${uniq(f.map(x=>x.Modalidade))}</b></div>
      <div class="kpi"><div class="small">Empreendimentos</div><b>${uniq(f.map(x=>x.Emp))}</b></div>
    </div>`;
  const total = f.reduce((a,r)=>a+r.Valor,0);
  valorTotal.textContent = `Total: ${BRL(total)}`;
  kpiProj.textContent = f.length.toLocaleString("pt-BR");
  kpiMuni.textContent = new Set(f.map(x=>x.Muni)).size.toLocaleString("pt-BR");

  const valid = f.map(r=>r.ExecPct).filter(x=>isFinite(x));
  const execMedia = valid.length ? valid.reduce((a,b)=>a+b,0)/valid.length : 0;
  kpiExec.textContent = `${pct1(execMedia)}%`;
}

function piePlot(divId, key){
  const a = aggSimple(key);
  const labels = a.map(x=>x.k);
  const hover = a.map(x=>`${x.k}<br><b>${BRL(x.v)}</b><br>Exec. m√©dia: ${pct1(x.exec)}%<br>Qtd: ${x.n.toLocaleString("pt-BR")}`);
  Plotly.newPlot(divId,[{
    labels, values:a.map(x=>x.v), type:"pie", hole:.25, textinfo:"label+percent",
    hovertemplate: hover.map(h=>h+"<extra></extra>")
  }],{
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)", legend:{orientation:"h"}
  },{responsive:true});
  const el=document.getElementById(divId);
  el.on('plotly_click', d=>{
    const label = a[d.points[0].pointIndex].k;
    DRILL[key] = (DRILL[key]===label)? null: label;
    renderAll();
  });
}

function barPlotVertical(divId, key){
  const a = aggSimple(key);
  const w = Math.max(1000, 26*a.length + 800);
  const data = [{
    x:a.map(x=>ellips(x.k, 50)), y:a.map(x=>x.v),
    type:"bar", marker:{color:"#e11d2e"},
    text:a.map(x=>x.n.toLocaleString("pt-BR")),
    customdata:a.map(x=>x.k),
    meta:a.map(x=>pct1(x.exec)),
    hovertemplate:"%{customdata}<br><b>%{y:,.2f}</b><br>Exec. m√©dia: %{meta}%<br>Qtd: %{text}<extra></extra>"
  }];
  const layout={
    width:w, height:440, bargap:0.25,
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    margin:{l:110,r:20,t:10,b:200},
    xaxis:{tickangle:-30, automargin:true},
    yaxis:{tickformat:",.2f"}
  };
  Plotly.newPlot(divId, data, layout, {responsive:true});
  document.getElementById(divId).on('plotly_click', d=>{
    const label = a[d.points[0].pointIndex].k;
    DRILL[key] = (DRILL[key]===label)? null: label;
    renderAll();
  });
}

function barPlotHorizontal(divId, key){
  const a = aggSimple(key);
  const h = Math.min(1600, Math.max(560, 22*a.length+140));
  const data=[{
    x:a.map(x=>x.v), y:a.map(x=>ellips(x.k, 90)),
    type:"bar", orientation:"h", marker:{color:"#e11d2e"},
    text:a.map(x=>x.n.toLocaleString("pt-BR")),
    customdata:a.map(x=>x.k), meta:a.map(x=>pct1(x.exec)),
    hovertemplate:"%{customdata}<br><b>%{x:,.2f}</b><br>Exec. m√©dia: %{meta}%<br>Qtd: %{text}<extra></extra>"
  }];
  const layout={
    height:h, bargap:0.25,
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    margin:{l:360,r:20,t:10,b:50},
    xaxis:{tickformat:",.2f"},
    yaxis:{automargin:true}
  };
  Plotly.newPlot(divId, data, layout, {responsive:true});
  document.getElementById(divId).on('plotly_click', d=>{
    const label = a[d.points[0].pointIndex].k;
    DRILL[key] = (DRILL[key]===label)? null: label;
    renderAll();
  });
}

function renderAll(){
  renderHierarchyAndKPIs();
  renderBadges();
  piePlot("chartExecutor","Executor");
  piePlot("chartEstagio","Estagio");
  barPlotVertical("chartClassificacao","Classificacao");
  barPlotVertical("chartEixo","Eixo");
  barPlotHorizontal("chartSubeixo","Subeixo");
  barPlotHorizontal("chartModalidade","Modalidade");
  barPlotHorizontal("chartEmp","Emp");
  buildTablesForPDF();
}

/* ---------- PDF (s√≥ tabelas) ---------- */
function buildOneTable(rows, key){
  const totalValor = rows.reduce((a,r)=>a+r.Valor,0);
  const map={};
  rows.forEach(r=>{
    const k=r[key]||"N√£o informado";
    if(!map[k]) map[k]={n:0, val:0, pctVals:[]};
    map[k].n+=1;
    map[k].val+=r.Valor;
    if (isFinite(r.ExecPct)) map[k].pctVals.push(r.ExecPct);
  });
  const arr=Object.entries(map).map(([k,o])=>{
    const exec = o.pctVals.length? o.pctVals.reduce((a,b)=>a+b,0)/o.pctVals.length : 0;
    const share = totalValor>0? (o.val/totalValor*100):0;
    return {categoria:k, qtd:o.n, exec, valor:o.val, share};
  }).sort((a,b)=>b.valor-a.valor);

  let html = `<h2>${key}</h2><table class="report"><thead>
  <tr><th>Categoria</th><th>Quantidade</th><th>Execu√ß√£o m√©dia (%)</th><th>Soma do valor (R$)</th><th>% do total (valor)</th></tr>
  </thead><tbody>`;
  arr.forEach(r=>{
    html+=`<tr>
      <td>${r.categoria}</td>
      <td>${r.qtd.toLocaleString("pt-BR")}</td>
      <td>${pct1(r.exec)}%</td>
      <td>${BRL(r.valor)}</td>
      <td>${pct1(r.share)}%</td>
    </tr>`;
  });
  html+=`</tbody><tfoot><tr>
    <td><b>TOTAL</b></td>
    <td><b>${rows.length.toLocaleString("pt-BR")}</b></td>
    <td><b>${pct1(avgValid(rows.map(x=>x.ExecPct)))}%</b></td>
    <td><b>${BRL(totalValor)}</b></td>
    <td><b>100,0%</b></td>
  </tr></tfoot></table>`;
  return html;
}
function avgValid(arr){
  const v=arr.filter(x=>isFinite(x));
  return v.length? v.reduce((a,b)=>a+b,0)/v.length : 0;
}
function buildTablesForPDF(){
  const f = actRows();
  const keys = ["Executor","Estagio","Classificacao","Eixo","Subeixo","Modalidade"];
  const tables = keys.map(k=>buildOneTable(f,k)).join("");
  const fonte = `<div class="source">Fonte: Novo PAC (2023-2030) ‚Äì Casa Civil, Governo Federal (atualiza√ß√£o: Ago/2025)</div>`;
  const node = document.getElementById("tables");
  node.innerHTML = tables + fonte;
}
function makePDF(){
  const node = document.getElementById("tables");
  node.classList.add("show");
  const opt = {
    margin: [10,10,10,10],
    filename: 'relatorio_pac_tabelas.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, background: '#ffffff' },
    jsPDF: { unit: 'pt', format: 'a4', orientation: 'landscape' }
  };
  html2pdf().set(opt).from(node).save().then(()=>{
    node.classList.remove("show");
  });
}
</script>
</body>
</html>
