<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel do Novo PAC ‚Äì Rio Grande do Sul</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{ --bg:#ffffff; --panel:#f4f5f7; --text:#111; --muted:#555; --accent:#e11d2e; }
.dark { --bg:#0a0a0a; --panel:#181a1b; --text:#fff; --muted:#c9c9c9; --accent:#ef4444; }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;padding:18px;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
.wrap{max-width:1500px;margin:0 auto}
h1{margin:0 0 6px;font-size:26px}
h2{margin:0 0 10px;font-size:20px;color:var(--accent)}
.meta{color:var(--muted);margin-bottom:10px}
.card{background:var(--panel);border:1px solid #d6d7da;border-radius:12px;padding:16px;margin:0 0 18px}
.dark .card{border-color:#2a2d2f}
select{padding:8px 10px;border:1px solid #b9bdc0;border-radius:8px;background:var(--bg);color:var(--text);margin-right:10px}
.dark select{border-color:#3c4043}
.btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
.btn-accent{background:var(--accent);color:#fff}
.btn-muted{background:#999;color:#fff}
.topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto;display:flex;gap:8px}
#valorTotal{background:var(--accent);color:#fff;padding:14px;border-radius:12px;text-align:center;font-size:28px;font-weight:700}
.kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpi{background:var(--panel);border:1px solid #d6d7da;border-radius:10px;padding:10px 12px;min-width:180px}
.dark .kpi{border-color:#2a2d2f}
.kpi b{display:block;font-size:18px;margin-top:4px}
.chart{height:420px}
.scroll-x{overflow-x:auto}
.chart.wide{width:1700px}
.chart.wider{width:2200px}
.badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.badge{background:#e8eaed;color:#111;border-radius:20px;padding:4px 10px;font-size:12px;border:1px solid #cfd1d4}
.dark .badge{background:#2a2d2f;color:#fff;border-color:#3a3d40}
.badge .x{margin-left:6px;cursor:pointer}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap" id="pagina">
  <div class="topbar">
    <div>
      <h1>Painel do Novo PAC ‚Äì Rio Grande do Sul</h1>
      <div class="meta">Fonte: Novo PAC ‚Äì Casa Civil ‚Äì Governo Federal ‚Äî Atualiza√ß√£o Agosto/2025</div>
    </div>
    <div class="right">
      <button id="themeBtn" class="btn btn-accent" title="Alternar tema">üåô/‚òÄÔ∏è</button>
      <button id="pdfBtn" class="btn btn-accent" title="Baixar PDF">üìÑ PDF</button>
    </div>
  </div>

  <div id="valorTotal">Total: R$ 0,00</div>
  <div class="kpis">
    <div class="kpi"><div class="small">Empreendimentos</div><b id="kpiProj">‚Äì</b></div>
    <div class="kpi"><div class="small">Munic√≠pios</div><b id="kpiMuni">‚Äì</b></div>
    <div class="kpi"><div class="small">Execu√ß√£o m√©dia</div><b id="kpiExec">‚Äì</b></div>
  </div>

  <div class="card">
    <div class="topbar">
      <div>
        <b>Atualiza√ß√£o:</b>
        <select id="selAtual"></select>
        <b>Munic√≠pio:</b>
        <select id="selMuni"><option>Todos</option></select>
      </div>
      <div class="right">
        <button id="resetBtn" class="btn btn-muted">üîÑ Reset filtros</button>
      </div>
    </div>
    <div class="badges" id="badges"></div>
  </div>

  <div class="card"><h2>Estrutura Hier√°rquica</h2><div id="hier"></div></div>

  <div class="card"><h2>Tipo de Executor</h2><div id="chartExecutor" class="chart"></div></div>
  <div class="card"><h2>Est√°gio</h2><div id="chartEstagio" class="chart"></div></div>

  <div class="card"><h2>Classifica√ß√£o</h2><div id="chartClassificacao" class="chart"></div></div>
  <div class="card"><h2>Eixo</h2><div id="chartEixo" class="chart"></div></div>

  <div class="card scroll-x"><h2>Subeixo</h2><div id="chartSubeixo" class="chart wide"></div></div>
  <div class="card scroll-x"><h2>Modalidade</h2><div id="chartModalidade" class="chart wide"></div></div>
  <div class="card scroll-x"><h2>Empreendimentos</h2><div id="chartEmp" class="chart wider"></div></div>

  <div class="small">Clique em qualquer gr√°fico para filtrar; clique novamente para desfazer. Use ‚ÄúReset filtros‚Äù para limpar tudo.</div>
</div>

<script>
const CSV_FILE = "https://raw.githack.com/lucascunha1979/painel_pac/main/pac_abril_julho_agosto_v1.csv";

const BRL = n => isFinite(n) ? n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}) : "R$¬†0,00";
const parseMoney = s => parseFloat(String(s||"").replace(/R\\$|\\s|\\./g,"").replace(",", "."))||0;
const parsePct = s => parseFloat(String(s||"").replace("%","").replace(",", "."))||0;
const wrap = (txt, len=22) => String(txt||"").replace(new RegExp(`(?![^\\n]{1,${len}}$)([^\\n]{1,${len}})\\s`,"g"),"$1<br>");
const ellipsize = (txt, len=28) => {
  const s = String(txt||"");
  return s.length>len ? s.slice(0,len-1)+"‚Ä¶" : s;
};
const byUpdateOrder = v => { const x = String(v||"").toLowerCase();
  if (x.includes("abr")) return 1;
  if (x.includes("jul")) return 2;
  if (x.includes("ago")) return 3;
  return 0;
};

let RAW = [];
let FILTERS = { Atual:null, Muni:"Todos" };
let DRILL = { Executor:null, Estagio:null, Classificacao:null, Eixo:null, Subeixo:null, Modalidade:null };

Papa.parse(CSV_FILE,{
  download:true, header:true, skipEmptyLines:true,
  complete: (res)=>{
    RAW = res.data.map(r=>({
      Atual:r["Atualiza√ß√£o"]||r["Atualizacao"]||"",
      Muni: r["Munic√≠pio"]||r["Municipio"]||"",
      Executor: r["Tipo de Executor"]||"",
      Estagio: r["Est√°gio"]||r["Estagio"]||"",
      Classificacao: r["Classifica√ß√£o"]||r["Classificacao"]||"",
      Eixo: r["Eixo"]||"",
      Subeixo: r["Subeixo"]||"",
      Modalidade: r["Modalidade"]||"",
      Emp: r["Empreendimento"]||"",
      Valor: parseMoney(r["Estimativa do valor total do empreendimento no Novo PAC (2023-2030) (R$)"]),
      ExecPct: parsePct(r["Percentual de execu√ß√£o do empreendimento (%)"])
    })).filter(r=>r.Atual && r.Eixo);

    initFilters();
    renderAll();
  },
  error:(e)=>alert("Erro ao carregar CSV: "+e.message)
});

function initFilters(){
  const u = [...new Set(RAW.map(d=>d.Atual))].sort((a,b)=>byUpdateOrder(a)-byUpdateOrder(b));
  selAtual.innerHTML = u.map(v=>`<option>${v}</option>`).join("");
  FILTERS.Atual = u[u.length-1];
  selAtual.value = FILTERS.Atual;
  selAtual.onchange = e => { FILTERS.Atual = e.target.value; renderAll(); };

  const m = [...new Set(RAW.map(d=>d.Muni))].filter(Boolean).sort();
  m.forEach(v=> selMuni.innerHTML += `<option>${v}</option>`);
  selMuni.onchange = e => { FILTERS.Muni = e.target.value; renderAll(); };

  document.getElementById("resetBtn").onclick = ()=>{ DRILL = { Executor:null, Estagio:null, Classificacao:null, Eixo:null, Subeixo:null, Modalidade:null }; renderAll(); };
  document.getElementById("themeBtn").onclick = ()=>{ document.body.classList.toggle("dark"); };
}

function activeRows(){
  return RAW.filter(r =>
    r.Atual === FILTERS.Atual &&
    (FILTERS.Muni==="Todos" || r.Muni===FILTERS.Muni) &&
    (!DRILL.Executor || r.Executor===DRILL.Executor) &&
    (!DRILL.Estagio || r.Estagio===DRILL.Estagio) &&
    (!DRILL.Classificacao || r.Classificacao===DRILL.Classificacao) &&
    (!DRILL.Eixo || r.Eixo===DRILL.Eixo) &&
    (!DRILL.Subeixo || r.Subeixo===DRILL.Subeixo) &&
    (!DRILL.Modalidade || r.Modalidade===DRILL.Modalidade)
  );
}

function renderBadges(){
  const b = [];
  for (const [k,v] of Object.entries(DRILL)) if (v) b.push(`<span class="badge">${k}: ${v}<span class="x" data-k="${k}">‚úï</span></span>`);
  badges.innerHTML = b.join("") || `<span class="small">Nenhum filtro aplicado.</span>`;
  badges.querySelectorAll(".x").forEach(x=> x.onclick = (e)=>{ const k=e.target.dataset.k; DRILL[k]=null; renderAll(); });
}

function aggWeighted(key){
  const m = {};
  activeRows().forEach(r=>{
    const k = r[key] || "N√£o informado";
    if(!m[k]) m[k]={sum:0, w:0};
    m[k].sum += r.Valor;
    m[k].w   += r.Valor * (r.ExecPct/100);
  });
  return Object.entries(m).map(([k,o])=>({k, v:o.sum, exec: o.sum? (o.w/o.sum*100):0})).sort((a,b)=>b.v-a.v);
}

function renderHierarchyAndKPIs(){
  const f = activeRows();
  const uniq = arr => new Set(arr).size;
  hier.innerHTML = `
    <div class="kpis" style="margin-top:0">
      <div class="kpi"><div class="small">Eixos</div><b>${uniq(f.map(x=>x.Eixo))}</b></div>
      <div class="kpi"><div class="small">Subeixos</div><b>${uniq(f.map(x=>x.Subeixo))}</b></div>
      <div class="kpi"><div class="small">Modalidades</div><b>${uniq(f.map(x=>x.Modalidade))}</b></div>
      <div class="kpi"><div class="small">Empreendimentos</div><b>${uniq(f.map(x=>x.Emp))}</b></div>
    </div>`;
  const total = f.reduce((a,r)=>a+r.Valor,0);
  valorTotal.textContent = `Total: ${BRL(total)}`;
  kpiProj.textContent   = f.length.toLocaleString("pt-BR");
  kpiMuni.textContent   = new Set(f.map(x=>x.Muni)).size.toLocaleString("pt-BR");
  const execMedia = f.length ? f.reduce((a,r)=>a+r.ExecPct,0)/f.length : 0;
  kpiExec.textContent   = `${execMedia.toFixed(2).replace(".",",")}%`;
}

function piePlot(divId, key){
  const a = aggWeighted(key);
  Plotly.newPlot(divId,[{
    labels:a.map(x=>wrap(x.k,20)),
    values:a.map(x=>x.v),
    type:"pie", hole:.25, textinfo:"label+percent",
    hovertemplate:"%{label}<br><b>%{customdata}</b><extra></extra>",
    customdata: a.map(x=>BRL(x.v))
  }],{
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    font:{color:getComputedStyle(document.body).getPropertyValue('--text')},
    legend:{orientation:"h"}
  },{responsive:true});

  const el = document.getElementById(divId);
  el.on('plotly_click', d=>{
    const label = d.points[0].label.replace(/<br>/g," ");
    const cur = DRILL[key];
    DRILL[key] = (cur===label) ? null : label;
    renderAll();
  });
}

function barPlot(divId, key, opts={}){
  const a = aggWeighted(key);
  const cfg = Object.assign({horizontal:false}, opts);

  const labelsFull = a.map(x=>x.k);
  const labelsShort = labelsFull.map(s=>ellipsize(s, 30));
  const maxLen = labelsShort.reduce((m,s)=>Math.max(m, s.length), 0);
  const dynBottom = cfg.forceBigBottom
      ? Math.min(320, 100 + maxLen*4)
      : Math.min(260, 70 + maxLen*3);

  const x = cfg.horizontal ? a.map(x=>x.v) : labelsShort;
  const y = cfg.horizontal ? labelsShort : a.map(x=>x.v);

  const data = [{
    x, y,
    type:"bar",
    orientation: cfg.horizontal ? "h" : "v",
    marker:{color:getComputedStyle(document.body).getPropertyValue('--accent')},
    customdata: a.map(x=>BRL(x.v)),
    meta: labelsFull,
    hovertemplate: cfg.horizontal
      ? "%{meta}<br><b>%{customdata}</b><extra></extra>"
      : "%{meta}<br><b>%{customdata}</b><extra></extra>"
  }];

  const layout = {
    paper_bgcolor:"rgba(0,0,0,0)",
    plot_bgcolor:"rgba(0,0,0,0)",
    font:{color:getComputedStyle(document.body).getPropertyValue('--text')},
    margin: cfg.horizontal ? {l:300,r:30,t:10,b:40} : {l:60,r:30,t:10,b:dynBottom},
    xaxis: { automargin:true, tickangle: cfg.horizontal ? 0 : -25 },
    yaxis: { automargin:true, tickformat:",.0f" }
  };

  Plotly.newPlot(divId, data, layout, {responsive:true});

  const el = document.getElementById(divId);
  el.on('plotly_click', d=>{
    const label = labelsFull[d.points[0].pointIndex];
    const cur = DRILL[key];
    DRILL[key] = (cur===label) ? null : label;
    renderAll();
  });
}

function barPlotTall(divId, key){
  const a = aggWeighted(key);
  const h = Math.max(420, 26*a.length);
  const el = document.getElementById(divId);
  el.style.height = h + "px";
  barPlot(divId, key, {horizontal:true});
}

function renderAll(){
  renderHierarchyAndKPIs();
  renderBadges();
  piePlot("chartExecutor","Executor");
  piePlot("chartEstagio","Estagio");
  barPlot("chartClassificacao","Classificacao",{forceBigBottom:true});
  barPlot("chartEixo","Eixo",{forceBigBottom:true});
  barPlotTall("chartSubeixo","Subeixo");
  barPlotTall("chartModalidade","Modalidade");
  barPlotTall("chartEmp","Emp");
}

document.getElementById("pdfBtn").onclick = async ()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("l","pt","a4");
  const cards = document.querySelectorAll(".card");
  for (let i=0;i<cards.length;i++){
    const node = cards[i];
    const canvas = await html2canvas(node, {scale:1.6, backgroundColor:getComputedStyle(document.body).getPropertyValue('--bg')});
    const img = canvas.toDataURL("image/png");
    const pw = pdf.internal.pageSize.getWidth();
    const ph = pdf.internal.pageSize.getHeight();
    const ratio = Math.min(pw/canvas.width, ph/canvas.height);
    const w = canvas.width * ratio;
    const h = canvas.height * ratio;
    pdf.addImage(img, "PNG", (pw-w)/2, (ph-h)/2, w, h);
    if (i < cards.length-1) pdf.addPage("a4","landscape");
  }
  pdf.save("Painel_PAC_RS.pdf");
};
</script>
</body>
</html>
