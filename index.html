<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel do Novo PAC ‚Äì Rio Grande do Sul</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{ --bg:#ffffff; --panel:#f4f5f7; --text:#111; --muted:#555; --accent:#e11d2e; }
.dark { --bg:#0a0a0a; --panel:#181a1b; --text:#fff; --muted:#c9c9c9; --accent:#ef4444; }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;padding:18px;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
.wrap{max-width:1500px;margin:0 auto}
h1{margin:0 0 6px;font-size:26px}
h2{margin:0 0 10px;font-size:20px;color:var(--accent)}
.meta{color:var(--muted);margin-bottom:10px}
.card{background:var(--panel);border:1px solid #d6d7da;border-radius:12px;padding:16px;margin:0 0 18px}
.dark .card{border-color:#2a2d2f}
select{padding:8px 10px;border:1px solid #b9bdc0;border-radius:8px;background:var(--bg);color:var(--text);margin-right:10px}
.dark select{border-color:#3c4043}
.btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
.btn-accent{background:var(--accent);color:#fff}
.btn-muted{background:#999;color:#fff}
.topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto;display:flex;gap:8px}
#valorTotal{background:var(--accent);color:#fff;padding:14px;border-radius:12px;text-align:center;font-size:28px;font-weight:700}
.kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpi{background:var(--panel);border:1px solid #d6d7da;border-radius:10px;padding:10px 12px;min-width:190px}
.dark .kpi{border-color:#2a2d2f}
.kpi b{display:block;font-size:18px;margin-top:4px}
.chart{height:430px}
.scroll-x{overflow-x:auto}
.scroll-y{max-height:520px; overflow-y:auto}
.chart.wide{width:1700px}
.chart.wider{width:2200px}
.badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.badge{background:#e8eaed;color:#111;border-radius:20px;padding:4px 10px;font-size:12px;border:1px solid #cfd1d4}
.dark .badge{background:#2a2d2f;color:#fff;border-color:#3a3d40}
.badge .x{margin-left:6px;cursor:pointer}
.small{font-size:12px;color:var(--muted)}
.trunc {max-width:420px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
/* relat√≥rio (tabelas) escondido na tela */
#reportRoot{ display:none; }
.report-section{ padding:16px; }
.report-title{ font-size:22px; font-weight:700; margin:0 0 8px; }
.report-meta{ color:#666; font-size:12px; margin-bottom:10px; }
.report-table{ width:100%; border-collapse:collapse; font-size:12px; }
.report-table th, .report-table td{ border:1px solid #999; padding:6px 8px; text-align:left; }
.report-table th{ background:#f0f0f0; }
.report-footer{ font-size:11px; color:#444; margin-top:6px; }
</style>
</head>
<body class="">
<div class="wrap" id="pagina">
  <div class="topbar pdf-section">
    <div>
      <h1>Painel do Novo PAC ‚Äì Rio Grande do Sul</h1>
      <div class="meta">Fonte: Novo PAC ‚Äì Casa Civil ‚Äì Governo Federal ‚Äî Atualiza√ß√£o Agosto/2025</div>
    </div>
    <div class="right">
      <button id="themeBtn" class="btn btn-accent" title="Alternar tema">üåô/‚òÄÔ∏è</button>
      <button id="pdfBtn" class="btn btn-accent" title="Baixar PDF (Tabelas)">üìÑ PDF</button>
    </div>
  </div>

  <div id="valorTotal" class="pdf-section">Total: R$ 0,00</div>
  <div class="kpis pdf-section">
    <div class="kpi"><div class="small">Empreendimentos</div><b id="kpiEmp">‚Äì</b></div>
    <div class="kpi"><div class="small">Munic√≠pios</div><b id="kpiMuni">‚Äì</b></div>
    <div class="kpi"><div class="small">Execu√ß√£o m√©dia</div><b id="kpiExec">‚Äì</b></div>
  </div>

  <div class="card pdf-section">
    <div class="topbar">
      <div>
        <b>Atualiza√ß√£o:</b>
        <select id="selAtual"></select>
        <b>Munic√≠pio:</b>
        <select id="selMuni"><option>Todos</option></select>
      </div>
      <div class="right">
        <button id="resetBtn" class="btn btn-muted">üîÑ Reset filtros</button>
      </div>
    </div>
    <div class="badges" id="badges"></div>
  </div>

  <div class="card pdf-section">
    <h2>Estrutura Hier√°rquica</h2>
    <div id="hier"></div>
  </div>

  <!-- GR√ÅFICOS (inalterados) -->
  <div class="card pdf-section"><h2>Tipo de Executor</h2><div id="chartExecutor" class="chart"></div></div>
  <div class="card pdf-section"><h2>Est√°gio</h2><div id="chartEstagio" class="chart"></div></div>
  <div class="card pdf-section"><h2>Classifica√ß√£o</h2><div id="chartClassificacao" class="chart"></div></div>

  <div class="card pdf-section scroll-x"><h2>Eixo</h2><div id="chartEixo" class="chart wide"></div></div>
  <div class="card pdf-section scroll-y"><h2>Subeixo</h2><div id="chartSubeixo" class="chart"></div></div>
  <div class="card pdf-section scroll-y"><h2>Modalidade</h2><div id="chartModalidade" class="chart"></div></div>
  <div class="card pdf-section scroll-y"><h2>Empreendimentos</h2><div id="chartEmp" class="chart"></div></div>

  <div class="small">Clique em qualquer gr√°fico para filtrar; clique novamente para desfazer. Use ‚ÄúReset filtros‚Äù para limpar tudo.</div>
</div>

<!-- CONTE√öDO DO RELAT√ìRIO (apenas tabelas) -->
<div id="reportRoot"></div>

<script>
// ======= CONFIG =======
const CSV_CANDIDATES = [
  "https://raw.githack.com/lucascunha1979/painel_pac/main/pac_abril_julho_agosto_v1.csv",
  "https://cdn.jsdelivr.net/gh/lucascunha1979/painel_pac@main/pac_abril_julho_agosto_v1.csv",
  "https://raw.githubusercontent.com/lucascunha1979/painel_pac/main/pac_abril_julho_agosto_v1.csv"
];

// ======= HELPERS =======
const BRL2 = n => isFinite(n) ? n.toLocaleString("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:2,maximumFractionDigits:2}) : "R$ 0,00";
const parseMoney = s => parseFloat(String(s||"").replace(/R\$|\s|\./g,"").replace(",", "."))||0;
const parsePct   = s => parseFloat(String(s||"").replace("%","").replace(",", "."));
const wrap = (txt, len=28) => String(txt||"").length>len ? String(txt).slice(0,len-1)+"‚Ä¶" : String(txt||"");
const byUpdateOrder = v => { const x = String(v||"").toLowerCase();
  if (x.includes("abr")) return 1; if (x.includes("jul")) return 2; if (x.includes("ago")) return 3; return 0;
};

// ======= STATE =======
let RAW = [];
let FILTERS = { Atual:null, Muni:"Todos" };
let DRILL = { Executor:null, Estagio:null, Classificacao:null, Eixo:null, Subeixo:null, Modalidade:null };

// ======= LOAD CSV =======
function loadCSV(candidates){
  if(!candidates.length){ alert("Falha ao carregar o CSV."); return; }
  Papa.parse(candidates[0],{
    download:true, header:true, skipEmptyLines:true,
    complete: (res)=>{
      if(res && res.data && res.data.length){
        RAW = res.data.map(r=>({
          Atual:r["Atualiza√ß√£o"]||r["Atualizacao"]||"",
          Muni: r["Munic√≠pio"]||r["Municipio"]||"",
          Executor: r["Tipo de Executor"]||"",
          Estagio: r["Est√°gio"]||r["Estagio"]||"",
          Classificacao: r["Classifica√ß√£o"]||r["Classificacao"]||"",
          Eixo: r["Eixo"]||"",
          Subeixo: r["Subeixo"]||"",
          Modalidade: r["Modalidade"]||"",
          Emp: r["Empreendimento"]||"",
          Valor: parseMoney(r["Estimativa do valor total do empreendimento no Novo PAC (2023-2030) (R$)"]),
          ExecPct: parsePct(r["Percentual de execu√ß√£o do empreendimento (%)"])
        })).filter(r=>r.Atual && r.Eixo);
        initFilters(); renderAll();
      }else{
        loadCSV(candidates.slice(1));
      }
    },
    error: ()=> loadCSV(candidates.slice(1))
  });
}
loadCSV(CSV_CANDIDATES);

// ======= FILTERS =======
function initFilters(){
  const u = [...new Set(RAW.map(d=>d.Atual))].sort((a,b)=>byUpdateOrder(a)-byUpdateOrder(b));
  selAtual.innerHTML = u.map(v=>`<option>${v}</option>`).join("");
  FILTERS.Atual = u[u.length-1];
  selAtual.value = FILTERS.Atual;
  selAtual.onchange = e => { FILTERS.Atual = e.target.value; renderAll(); };

  const m = [...new Set(RAW.map(d=>d.Muni))].filter(Boolean).sort();
  m.forEach(v=> selMuni.innerHTML += `<option>${v}</option>`);
  selMuni.onchange = e => { FILTERS.Muni = e.target.value; renderAll(); };

  document.getElementById("resetBtn").onclick = ()=>{ DRILL = { Executor:null, Estagio:null, Classificacao:null, Eixo:null, Subeixo:null, Modalidade:null }; renderAll(); };
  document.getElementById("themeBtn").onclick = ()=>{ document.body.classList.toggle("dark"); };
}

function activeRows(){
  return RAW.filter(r =>
    r.Atual === FILTERS.Atual &&
    (FILTERS.Muni==="Todos" || r.Muni===FILTERS.Muni) &&
    (!DRILL.Executor || r.Executor===DRILL.Executor) &&
    (!DRILL.Estagio || r.Estagio===DRILL.Estagio) &&
    (!DRILL.Classificacao || r.Classificacao===DRILL.Classificacao) &&
    (!DRILL.Eixo || r.Eixo===DRILL.Eixo) &&
    (!DRILL.Subeixo || r.Subeixo===DRILL.Subeixo) &&
    (!DRILL.Modalidade || r.Modalidade===DRILL.Modalidade)
  );
}

function renderBadges(){
  const b = [];
  for (const [k,v] of Object.entries(DRILL)) if (v) b.push(`<span class="badge">${k}: ${v}<span class="x" data-k="${k}">‚úï</span></span>`);
  badges.innerHTML = b.join("") || `<span class="small">Nenhum filtro aplicado.</span>`;
  badges.querySelectorAll(".x").forEach(x=> x.onclick = (e)=>{ const k=e.target.dataset.k; DRILL[k]=null; renderAll(); });
}

// ======= AGG =======
function aggWeighted(key){
  const m = {};
  activeRows().forEach(r=>{
    const k = r[key] || "N√£o informado";
    if(!m[k]) m[k]={sum:0, w:0};
    m[k].sum += r.Valor;
    m[k].w   += r.Valor * ((isFinite(r.ExecPct)?r.ExecPct:0)/100);
  });
  return Object.entries(m).map(([k,o])=>({k, v:o.sum, exec: o.sum? (o.w/o.sum*100):0})).sort((a,b)=>b.v-a.v);
}

// ======= HIER & KPIs =======
function renderHierarchyAndKPIs(){
  const f = activeRows();
  const uniq = arr => new Set(arr).size;
  hier.innerHTML = `
    <div class="kpis" style="margin-top:0">
      <div class="kpi"><div class="small">Eixos</div><b>${uniq(f.map(x=>x.Eixo))}</b></div>
      <div class="kpi"><div class="small">Subeixos</div><b>${uniq(f.map(x=>x.Subeixo))}</b></div>
      <div class="kpi"><div class="small">Modalidades</div><b>${uniq(f.map(x=>x.Modalidade))}</b></div>
      <div class="kpi"><div class="small">Empreendimentos</div><b>${uniq(f.map(x=>x.Emp))}</b></div>
    </div>`;
  const total = f.reduce((a,r)=>a+(isFinite(r.Valor)?r.Valor:0),0);
  valorTotal.textContent = `Total: ${BRL2(total)}`;

  // KPIs
  kpiEmp.textContent  = f.length.toLocaleString("pt-BR");
  kpiMuni.textContent = new Set(f.map(x=>x.Muni)).size.toLocaleString("pt-BR");
  const execVals = f.map(x=>x.ExecPct).filter(v=>isFinite(v));
  const execMedia = execVals.length ? execVals.reduce((a,b)=>a+b,0)/execVals.length : 0;
  kpiExec.textContent = `${execMedia.toFixed(2).replace(".",",")}%`;
}

// ======= GR√ÅFICOS (inalterados) =======
function piePlot(divId, key){
  const a = aggWeighted(key);
  const labelsFull = a.map(x=>x.k);
  const labelsShort = a.map(x=>wrap(x.k,24));
  Plotly.react(divId,[{
    labels: labelsShort, values: a.map(x=>x.v), type:"pie", hole:.25, textinfo:"label+percent",
    hovertext: labelsFull.map((l,i)=>`${l}<br><b>${BRL2(a[i].v)}</b><br>Exec. m√©dia: ${a[i].exec.toFixed(2).replace(".",",")}%`),
    hoverinfo:"text"
  }],{
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    font:{color:getComputedStyle(document.body).getPropertyValue('--text')}, legend:{orientation:"h"}
  },{responsive:true});
  document.getElementById(divId).on('plotly_click', d=>{
    const label = labelsFull[d.points[0].pointNumber];
    const cur = DRILL[key]; DRILL[key] = (cur===label) ? null : label; renderAll();
  });
}
function barPlotVertical(divId, key){
  const a = aggWeighted(key);
  const short = a.map(x=>wrap(x.k,26)); const full = a.map(x=>x.k);
  Plotly.react(divId, [{
    x: short, y: a.map(x=>x.v), type:"bar",
    marker:{color:getComputedStyle(document.body).getPropertyValue('--accent')},
    customdata: full.map((t,i)=>[t, BRL2(a[i].v), a[i].exec.toFixed(2).replace(".",",")]),
    hovertemplate: "%{customdata[0]}<br><b>%{customdata[1]}</b><br>Exec. m√©dia: %{customdata[2]}%<extra></extra>"
  }], {
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    font:{color:getComputedStyle(document.body).getPropertyValue('--text')},
    margin:{l:60,r:30,t:10,b:140}, yaxis:{tickformat:",.2f"}, xaxis:{automargin:true, tickangle:-30}
  }, {responsive:true});
  document.getElementById(divId).on('plotly_click', d=>{
    const label = full[d.points[0].pointNumber]; const cur = DRILL[key];
    DRILL[key] = (cur===label) ? null : label; renderAll();
  });
}
function barPlotHorizontal(divId, key){
  const a = aggWeighted(key);
  const h = Math.max(430, Math.min(24*a.length + 80, 1200));
  document.getElementById(divId).style.height = h + "px";
  const short = a.map(x=>wrap(x.k,40)); const full = a.map(x=>x.k);
  Plotly.react(divId, [{
    x: a.map(x=>x.v), y: short, type:"bar", orientation:"h",
    marker:{color:getComputedStyle(document.body).getPropertyValue('--accent')},
    customdata: full.map((t,i)=>[t, BRL2(a[i].v), a[i].exec.toFixed(2).replace(".",",")]),
    hovertemplate: "%{customdata[0]}<br><b>%{customdata[1]}</b><br>Exec. m√©dia: %{customdata[2]}%<extra></extra>"
  }], {
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    font:{color:getComputedStyle(document.body).getPropertyValue('--text')},
    margin:{l:300,r:30,t:10,b:40}, xaxis:{tickformat:",.2f"}, yaxis:{automargin:true}
  }, {responsive:true});
  document.getElementById(divId).on('plotly_click', d=>{
    const label = full[d.points[0].pointNumber]; const cur = DRILL[key];
    DRILL[key] = (cur===label) ? null : label; renderAll();
  });
}

// ======= RENDER ALL =======
function renderAll(){
  renderHierarchyAndKPIs();
  renderBadges();
  piePlot("chartExecutor","Executor");
  piePlot("chartEstagio","Estagio");
  barPlotVertical("chartClassificacao","Classificacao");
  barPlotVertical("chartEixo","Eixo");
  barPlotHorizontal("chartSubeixo","Subeixo");
  barPlotHorizontal("chartModalidade","Modalidade");
  barPlotHorizontal("chartEmp","Emp");
}

// ======= RELAT√ìRIO EM TABELAS =======
const TABLE_ORDER = [
  ["Executor", "Tipo de Executor"],
  ["Estagio", "Est√°gio"],
  ["Classificacao", "Classifica√ß√£o"],
  ["Eixo", "Eixo"],
  ["Subeixo", "Subeixo"],
  ["Modalidade", "Modalidade"],
  ["Emp", "Empreendimento"]
];

function buildGroupStats(key){
  // soma de Valor e m√©dia simples de ExecPct por categoria
  const m = {};
  activeRows().forEach(r=>{
    const k = r[key] || "N√£o informado";
    if(!m[k]) m[k]={sum:0, execVals:[]};
    m[k].sum += (isFinite(r.Valor)?r.Valor:0);
    if(isFinite(r.ExecPct)) m[k].execVals.push(r.ExecPct);
  });
  const rows = Object.entries(m).map(([k,o])=>{
    const mean = o.execVals.length ? (o.execVals.reduce((a,b)=>a+b,0)/o.execVals.length) : 0;
    return {cat:k, val:o.sum, exec:mean};
  }).sort((a,b)=>b.val-a.val);
  const total = rows.reduce((acc,r)=>acc+r.val,0);
  const execAll = [];
  activeRows().forEach(r=>{ if(isFinite(r.ExecPct)) execAll.push(r.ExecPct); });
  const execMediaGlobal = execAll.length ? (execAll.reduce((a,b)=>a+b,0)/execAll.length) : 0;
  return {rows, total, execMediaGlobal};
}

function buildReportHTML(){
  const f = activeRows();
  const total = f.reduce((a,r)=>a+(isFinite(r.Valor)?r.Valor:0),0);
  const uniq = arr => new Set(arr).size;
  const execVals = f.map(x=>x.ExecPct).filter(v=>isFinite(v));
  const execMedia = execVals.length ? execVals.reduce((a,b)=>a+b,0)/execVals.length : 0;

  let html = "";
  // CAPA
  html += `<section class="report-section">
    <div class="report-title">Painel do Novo PAC ‚Äì RS (Relat√≥rio em tabelas)</div>
    <div class="report-meta">Atualiza√ß√£o: <b>${FILTERS.Atual}</b> &nbsp;|&nbsp; Munic√≠pio: <b>${FILTERS.Muni}</b></div>
    <table class="report-table">
      <tr><th>Total (R$)</th><th>Empreendimentos</th><th>Munic√≠pios</th><th>Execu√ß√£o m√©dia (%)</th></tr>
      <tr><td>${BRL2(total)}</td><td>${f.length.toLocaleString("pt-BR")}</td><td>${uniq(f.map(x=>x.Muni))}</td><td>${execMedia.toFixed(2).replace(".",",")}%</td></tr>
    </table>
    <div class="report-footer">Fonte: Novo PAC (2023-2030) ‚Äî Casa Civil ‚Äì Governo Federal (atualiza√ß√£o agosto de 2025)</div>
  </section>`;

  // TABELAS POR CATEGORIA
  TABLE_ORDER.forEach(([key,label])=>{
    const g = buildGroupStats(key);
    const header = `<tr><th>${label}</th><th>Soma Valor (R$)</th><th>Execu√ß√£o m√©dia (%)</th></tr>`;
    const body = g.rows.map(r=>`<tr><td>${r.cat}</td><td>${BRL2(r.val)}</td><td>${r.exec.toFixed(2).replace(".",",")}%</td></tr>`).join("");
    const totalRow = `<tr><th>Total</th><th>${BRL2(g.total)}</th><th>${g.execMediaGlobal.toFixed(2).replace(".",",")}%</th></tr>`;
    html += `<section class="report-section">
      <div class="report-title">${label}</div>
      <table class="report-table">${header}${body}${totalRow}</table>
      <div class="report-footer">Fonte: Novo PAC (2023-2030) ‚Äî Casa Civil ‚Äì Governo Federal (atualiza√ß√£o agosto de 2025)</div>
    </section>`;
  });

  return html;
}

// ======= PDF (apenas tabelas, A4 paisagem, 1 se√ß√£o por p√°gina) =======
document.getElementById("pdfBtn").onclick = async ()=>{
  try{
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("l","pt","a4");

    // Prepara conte√∫do
    const reportRoot = document.getElementById("reportRoot");
    reportRoot.innerHTML = buildReportHTML();

    // captura se√ß√£o por se√ß√£o
    const sections = Array.from(reportRoot.querySelectorAll(".report-section"));
    for (let i=0;i<sections.length;i++){
      const node = sections[i];
      const canvas = await html2canvas(node, {scale:2, backgroundColor:"#ffffff"});
      const img = canvas.toDataURL("image/png");
      const pw = pdf.internal.pageSize.getWidth();
      const ph = pdf.internal.pageSize.getHeight();
      const ratio = Math.min(pw/canvas.width, ph/canvas.height);
      const w = canvas.width * ratio;
      const h = canvas.height * ratio;
      if(i>0) pdf.addPage("a4","landscape");
      pdf.addImage(img, "PNG", (pw-w)/2, (ph-h)/2, w, h);
    }
    pdf.save("Painel_PAC_RS_tabelas.pdf");
  }catch(e){
    alert("‚ö†Ô∏è Falha ao gerar o PDF. Detalhe: "+e.message);
  }
};

// ======= RENDER =======
function renderAll(){
  renderHierarchyAndKPIs();
  renderBadges();
  piePlot("chartExecutor","Executor");
  piePlot("chartEstagio","Estagio");
  barPlotVertical("chartClassificacao","Classificacao");
  barPlotVertical("chartEixo","Eixo");
  barPlotHorizontal("chartSubeixo","Subeixo");
  barPlotHorizontal("chartModalidade","Modalidade");
  barPlotHorizontal("chartEmp","Emp");
}
</script>
</body>
</html>