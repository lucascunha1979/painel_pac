<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel do Novo PAC ‚Äì Rio Grande do Sul</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Plotly para os gr√°ficos -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<!-- PapaParse para ler CSV -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<!-- html2pdf para gerar PDF paginado (tabelas apenas) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root{
  --bg:#ffffff; --panel:#f4f5f7; --text:#111; --muted:#555; --accent:#e11d2e;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;padding:18px;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
.wrap{max-width:1500px;margin:0 auto}
h1{margin:0 0 6px;font-size:26px}
h2{margin:0 0 10px;font-size:20px;color:var(--accent)}
.meta{color:var(--muted);margin-bottom:10px}
.card{background:var(--panel);border:1px solid #d6d7da;border-radius:12px;padding:16px;margin:0 0 18px}
select{padding:8px 10px;border:1px solid #b9bdc0;border-radius:8px;background:var(--bg);color:var(--text);margin-right:10px}
.btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
.btn-accent{background:var(--accent);color:#fff}
.btn-muted{background:#999;color:#fff}
.topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto;display:flex;gap:8px}
#valorTotal{background:var(--accent);color:#fff;padding:14px;border-radius:12px;text-align:center;font-size:28px;font-weight:700}
.kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpi{background:var(--panel);border:1px solid #d6d7da;border-radius:10px;padding:10px 12px;min-width:180px}
.kpi b{display:block;font-size:18px;margin-top:4px}
.small{font-size:12px;color:var(--muted)}
.badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.badge{background:#e8eaed;color:#111;border-radius:20px;padding:4px 10px;font-size:12px;border:1px solid #cfd1d4}
.badge .x{margin-left:6px;cursor:pointer}

/* containers de gr√°fico com rolagem quando necess√°rio */
.chart{height:420px}
.chart-v{height:460px; overflow-x:auto;}
.chart-h{height:540px; overflow-y:auto;}
.chart-wide{width:1700px}   /* para Eixo/Classifica√ß√£o quando houver muitas categorias */
.chart-wider{width:2200px}  /* se estourar muito */

/* TABELAS (PDF) */
#tables{display:none} /* s√≥ aparece no PDF */
#tables h2{color:#000;margin:16px 0 8px}
table.report{border-collapse:collapse;width:100%;font-size:11px}
table.report th, table.report td{border:1px solid #bbb;padding:6px;text-align:left;vertical-align:top}
table.report th{background:#efefef}
tfoot td{font-weight:700;background:#fafafa}
.source{margin-top:10px;color:#333;font-size:11px}
@media print{
  body{background:#fff}
}
</style>
</head>
<body>
<div class="wrap" id="app">

  <div class="topbar">
    <div>
      <h1>Painel do Novo PAC ‚Äì Rio Grande do Sul</h1>
      <div class="meta">Fonte: Novo PAC (2023-2030) ‚Äì Casa Civil, Governo Federal ‚Äî atualiza√ß√£o: Ago/2025</div>
    </div>
    <div class="right">
      <button id="btnPdf" class="btn btn-accent" title="Baixar PDF com tabelas">üìÑ PDF (tabelas)</button>
    </div>
  </div>

  <div id="valorTotal">Total: R$ 0,00</div>
  <div class="kpis">
    <div class="kpi"><div class="small">Empreendimentos</div><b id="kpiProj">‚Äì</b></div>
    <div class="kpi"><div class="small">Munic√≠pios</div><b id="kpiMuni">‚Äì</b></div>
    <div class="kpi"><div class="small">Execu√ß√£o m√©dia</div><b id="kpiExec">‚Äì</b></div>
  </div>

  <div class="card">
    <div class="topbar">
      <div>
        <b>Atualiza√ß√£o:</b>
        <select id="selAtual"></select>
        <b>Munic√≠pio:</b>
        <select id="selMuni"><option>Todos</option></select>
      </div>
      <div class="right">
        <button id="btnReset" class="btn btn-muted">üîÑ Reset filtros</button>
      </div>
    </div>
    <div class="badges" id="badges"></div>
  </div>

  <div class="card">
    <h2>Estrutura Hier√°rquica</h2>
    <div id="hier"></div>
  </div>

  <div class="card"><h2>Tipo de Executor</h2><div id="chartExecutor" class="chart chart-v"></div></div>
  <div class="card"><h2>Est√°gio</h2><div id="chartEstagio" class="chart chart-v"></div></div>
  <div class="card"><h2>Classifica√ß√£o</h2><div id="chartClassificacao" class="chart chart-v"></div></div>

  <div class="card"><h2>Eixo</h2><div id="chartEixo" class="chart chart-v"></div></div>
  <div class="card"><h2>Subeixo</h2><div id="chartSubeixo" class="chart chart-h"></div></div>
  <div class="card"><h2>Modalidade</h2><div id="chartModalidade" class="chart chart-h"></div></div>
  <div class="card"><h2>Empreendimentos</h2><div id="chartEmp" class="chart chart-h"></div></div>

  <div class="small">Clique em qualquer gr√°fico para filtrar; clique novamente para desfazer. ‚ÄúReset filtros‚Äù limpa tudo.</div>

  <!-- Se√ß√£o oculta com TABELAS (usada para gerar o PDF) -->
  <div id="tables"></div>

</div>

<script>
// ===================== CONFIG =====================
const CSV_FILE = "https://raw.githack.com/lucascunha1979/painel_pac/main/pac_abril_julho_agosto_v1.csv";

// ===================== HELPERS =====================
const nfBR2 = new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:2,maximumFractionDigits:2});
const pct1  = v => (isFinite(v)? (v.toFixed(1).replace(".",",")) : "0,0");
const BRL   = v => nfBR2.format(Math.round((v + Number.EPSILON)*100)/100);

function parseMoneyBR(s){
  if (s==null) return 0;
  const t = String(s).replace(/\s|R\$/g,"").replace(/\./g,"").replace(",",".");
  const n = parseFloat(t);
  return isFinite(n) ? n : 0;
}
function parsePctBR(s){
  if (s==null) return 0;
  const t = String(s).replace("%","").replace(",",".");
  const n = parseFloat(t);
  return isFinite(n) ? n : 0;
}
const wrap = (txt, len=28) => String(txt||"").replace(new RegExp(`(?![^\\n]{1,${len}}$)([^\\n]{1,${len}})\\s`,"g"),"$1<br>");
const ellips = (txt, len=40) => {
  const s = String(txt||"");
  return s.length>len ? s.slice(0,len-1)+"‚Ä¶" : s;
};

// ===================== STATE =====================
let RAW = [];
let FILTERS = { Atual:null, Muni:"Todos" };
let DRILL = { Executor:null, Estagio:null, Classificacao:null, Eixo:null, Subeixo:null, Modalidade:null };

// ===================== LOAD CSV =====================
Papa.parse(CSV_FILE,{
  download:true, header:true, skipEmptyLines:true,
  complete: (res)=>{
    RAW = res.data.map(r=>({
      Atual:  r["Atualiza√ß√£o"]||r["Atualizacao"]||"",
      Muni:   r["Munic√≠pio"]||r["Municipio"]||"",
      Executor: r["Tipo de Executor"]||"",
      Estagio:  r["Est√°gio"]||r["Estagio"]||"",
      Classificacao: r["Classifica√ß√£o"]||r["Classificacao"]||"",
      Eixo: r["Eixo"]||"",
      Subeixo: r["Subeixo"]||"",
      Modalidade: r["Modalidade"]||"",
      Emp: r["Empreendimento"]||"",
      Valor: parseMoneyBR(r["Estimativa do valor total do empreendimento no Novo PAC (2023-2030) (R$)"]),
      ExecPct: parsePctBR(r["Percentual de execu√ß√£o do empreendimento (%)"])
    })).filter(r=>r.Atual && r.Eixo);

    initFilters();
    renderAll();
  },
  error:(e)=>alert("Erro ao carregar CSV: "+e.message)
});

// ===================== FILTERS =====================
function byUpdateOrder(v){
  const x = String(v||"").toLowerCase();
  if (x.includes("abr")) return 1;
  if (x.includes("jul")) return 2;
  if (x.includes("ago")) return 3;
  return 0;
}
function initFilters(){
  const u = [...new Set(RAW.map(d=>d.Atual))].sort((a,b)=>byUpdateOrder(a)-byUpdateOrder(b));
  document.getElementById("selAtual").innerHTML = u.map(v=>`<option>${v}</option>`).join("");
  FILTERS.Atual = u[u.length-1];
  document.getElementById("selAtual").value = FILTERS.Atual;
  document.getElementById("selAtual").onchange = e => { FILTERS.Atual = e.target.value; renderAll(); };

  const m = [...new Set(RAW.map(d=>d.Muni))].filter(Boolean).sort();
  const selM = document.getElementById("selMuni");
  m.forEach(v=> selM.innerHTML += `<option>${v}</option>`);
  selM.onchange = e => { FILTERS.Muni = e.target.value; renderAll(); };

  document.getElementById("btnReset").onclick = ()=>{
    DRILL = { Executor:null, Estagio:null, Classificacao:null, Eixo:null, Subeixo:null, Modalidade:null };
    renderAll();
  };

  document.getElementById("btnPdf").onclick = ()=>makePDF();
}
function actRows(){
  return RAW.filter(r =>
    r.Atual === FILTERS.Atual &&
    (FILTERS.Muni==="Todos" || r.Muni===FILTERS.Muni) &&
    (!DRILL.Executor || r.Executor===DRILL.Executor) &&
    (!DRILL.Estagio || r.Estagio===DRILL.Estagio) &&
    (!DRILL.Classificacao || r.Classificacao===DRILL.Classificacao) &&
    (!DRILL.Eixo || r.Eixo===DRILL.Eixo) &&
    (!DRILL.Subeixo || r.Subeixo===DRILL.Subeixo) &&
    (!DRILL.Modalidade || r.Modalidade===DRILL.Modalidade)
  );
}
function renderBadges(){
  const b = [];
  for (const [k,v] of Object.entries(DRILL)) if (v) b.push(`<span class="badge">${k}: ${v}<span class="x" data-k="${k}">‚úï</span></span>`);
  const el = document.getElementById("badges");
  el.innerHTML = b.length? b.join("") : `<span class="small">Nenhum filtro aplicado.</span>`;
  el.querySelectorAll(".x").forEach(x=> x.onclick = (e)=>{ const k=e.target.dataset.k; DRILL[k]=null; renderAll(); });
}

// ===================== AGG =====================
function aggSimple(key){
  const m = {};
  actRows().forEach(r=>{
    const k = r[key] || "N√£o informado";
    if(!m[k]) m[k]={sumValor:0, n:0, sumPct:0};
    m[k].sumValor += r.Valor;
    m[k].n += 1;
    m[k].sumPct += r.ExecPct; // m√©dia simples!
  });
  return Object.entries(m).map(([k,o])=>({
    k,
    v:o.sumValor,
    n:o.n,
    exec:(o.n? (o.sumPct/o.n) : 0)
  })).sort((a,b)=>b.v-a.v);
}

// ===================== HIER + KPIs =====================
function renderHierarchyAndKPIs(){
  const f = actRows();
  const uniq = arr => new Set(arr).size;
  document.getElementById("hier").innerHTML = `
    <div class="kpis" style="margin-top:0">
      <div class="kpi"><div class="small">Eixos</div><b>${uniq(f.map(x=>x.Eixo))}</b></div>
      <div class="kpi"><div class="small">Subeixos</div><b>${uniq(f.map(x=>x.Subeixo))}</b></div>
      <div class="kpi"><div class="small">Modalidades</div><b>${uniq(f.map(x=>x.Modalidade))}</b></div>
      <div class="kpi"><div class="small">Empreendimentos</div><b>${uniq(f.map(x=>x.Emp))}</b></div>
    </div>`;
  const total = f.reduce((a,r)=>a+r.Valor,0);
  document.getElementById("valorTotal").textContent = `Total: ${BRL(total)}`;
  document.getElementById("kpiProj").textContent = f.length.toLocaleString("pt-BR");
  document.getElementById("kpiMuni").textContent = new Set(f.map(x=>x.Muni)).size.toLocaleString("pt-BR");
  const execMedia = f.length ? f.reduce((a,r)=>a+r.ExecPct,0)/f.length : 0; // simples
  document.getElementById("kpiExec").textContent = `${pct1(execMedia)}%`;
}

// ===================== PLOTS =====================
function piePlot(divId, key){
  const a = aggSimple(key);
  const labels = a.map(x=>wrap(x.k,22));
  const hover = a.map(x=>`${x.k}<br><b>${BRL(x.v)}</b><br>Exec. m√©dia: ${pct1(x.exec)}%<br>Qtd: ${x.n.toLocaleString("pt-BR")}`);
  Plotly.newPlot(divId,[{
    labels, values:a.map(x=>x.v), type:"pie", hole:.25, textinfo:"label+percent",
    hovertemplate: hover.map(h=>h+"<extra></extra>")
  }],{
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)", legend:{orientation:"h"}
  },{responsive:true});

  const el = document.getElementById(divId);
  el.on('plotly_click', d=>{
    const label = d.points[0].label.replace(/<br>/g," ");
    const plain = label;
    const cur = DRILL[key];
    DRILL[key] = (cur===plain) ? null : plain;
    renderAll();
  });
}

function barPlotVertical(divId, key){
  const a = aggSimple(key);
  // largura din√¢mica para evitar corte
  const w = Math.max(900, 24*a.length + 600);
  const x = a.map(x=>ellips(x.k, 36)); // eixo com retic√™ncias
  const data = [{
    x, y:a.map(x=>x.v), type:"bar",
    marker:{color:"#e11d2e"},
    customdata:a.map(x=>`${x.k}`),
    hovertemplate:"%{customdata}<br><b>%{y:,.2f}</b><br>Exec. m√©dia: %{meta}%<br>Qtd: %{text}<extra></extra>",
    text:a.map(x=>x.n.toLocaleString("pt-BR")),
    meta:a.map(x=>pct1(x.exec))
  }];
  const layout = {
    width: w, height: 420, bargap:0.25,
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    margin:{l:90,r:20,t:10,b:150},
    xaxis:{tickangle:-30, automargin:true},
    yaxis:{tickformat:",.2f"}
  };
  Plotly.newPlot(divId, data, layout, {responsive:true});
  document.getElementById(divId).on('plotly_click', d=>{
    const label = a[d.points[0].pointIndex].k;
    const cur = DRILL[key];
    DRILL[key] = (cur===label) ? null : label;
    renderAll();
  });
}

function barPlotHorizontal(divId, key){
  const a = aggSimple(key);
  // altura din√¢mica: 22px por categoria (m√≠n 540 / m√°x 1400 com rolagem do container)
  const h = Math.min(1400, Math.max(540, 22*a.length+100));
  const data = [{
    x:a.map(x=>x.v),
    y:a.map(x=>ellips(x.k, 70)),
    type:"bar", orientation:"h", marker:{color:"#e11d2e"},
    customdata:a.map(x=>x.k),
    meta:a.map(x=>pct1(x.exec)),
    text:a.map(x=>x.n.toLocaleString("pt-BR")),
    hovertemplate:"%{customdata}<br><b>%{x:,.2f}</b><br>Exec. m√©dia: %{meta}%<br>Qtd: %{text}<extra></extra>"
  }];
  const layout = {
    height: h, bargap:0.25,
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    margin:{l:310,r:20,t:10,b:40},
    xaxis:{tickformat:",.2f"}, yaxis:{automargin:true}
  };
  Plotly.newPlot(divId, data, layout, {responsive:true});
  document.getElementById(divId).on('plotly_click', d=>{
    const idx = d.points[0].pointIndex;
    const label = a[idx].k;
    const cur = DRILL[key];
    DRILL[key] = (cur===label) ? null : label;
    renderAll();
  });
}

// ===================== RENDER =====================
function renderAll(){
  renderHierarchyAndKPIs();
  renderBadges();
  piePlot("chartExecutor","Executor");
  piePlot("chartEstagio","Estagio");
  barPlotVertical("chartClassificacao","Classificacao");
  barPlotVertical("chartEixo","Eixo");
  barPlotHorizontal("chartSubeixo","Subeixo");
  barPlotHorizontal("chartModalidade","Modalidade");
  barPlotHorizontal("chartEmp","Emp");
  buildTablesForPDF(); // mant√©m as tabelas atualizadas para o PDF
}

// ===================== PDF (TABELAS APENAS) =====================
function buildOneTable(rows, key){
  const totalValor = rows.reduce((a,r)=>a+r.Valor,0);
  const map = {};
  rows.forEach(r=>{
    const k = r[key] || "N√£o informado";
    if(!map[k]) map[k]={n:0, sumVal:0, sumPct:0};
    map[k].n += 1;
    map[k].sumVal += r.Valor;
    map[k].sumPct += r.ExecPct;
  });
  const arr = Object.entries(map).map(([k,o])=>{
    const exec = o.n? (o.sumPct/o.n) : 0; // m√©dia simples
    const pctVal = totalValor>0 ? (o.sumVal/totalValor*100) : 0;
    return {categoria:k, qtd:o.n, exec, valor:o.sumVal, share:pctVal};
  }).sort((a,b)=>b.valor-a.valor);

  let html = `<h2>${key}</h2><table class="report"><thead>
    <tr><th>Categoria</th><th>Quantidade</th><th>Execu√ß√£o m√©dia (%)</th><th>Soma do valor (R$)</th><th>% do total (valor)</th></tr>
  </thead><tbody>`;
  arr.forEach(r=>{
    html += `<tr>
      <td>${r.categoria}</td>
      <td>${r.qtd.toLocaleString("pt-BR")}</td>
      <td>${pct1(r.exec)}%</td>
      <td>${BRL(r.valor)}</td>
      <td>${pct1(r.share)}%</td>
    </tr>`;
  });
  html += `</tbody><tfoot><tr>
    <td><b>TOTAL</b></td>
    <td><b>${rows.length.toLocaleString("pt-BR")}</b></td>
    <td><b>${pct1(rows.reduce((a,r)=>a+r.ExecPct,0)/(rows.length||1))}%</b></td>
    <td><b>${BRL(totalValor)}</b></td>
    <td><b>100,0%</b></td>
  </tr></tfoot></table>`;
  return html;
}
function buildTablesForPDF(){
  const f = actRows();
  const keys = ["Executor","Estagio","Classificacao","Eixo","Subeixo","Modalidade"];
  const tables = keys.map(k=>buildOneTable(f,k)).join("");
  const fonte = `<div class="source">Fonte: Novo PAC (2023-2030) ‚Äì Casa Civil, Governo Federal (atualiza√ß√£o: Ago/2025)</div>`;
  document.getElementById("tables").innerHTML = tables + fonte;
}
function makePDF(){
  const opt = {
    margin:       [10,10,10,10],
    filename:     'relatorio_pac_tabelas.pdf',
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS: true, background: '#ffffff' },
    jsPDF:        { unit: 'pt', format: 'a4', orientation: 'landscape' }
  };
  const node = document.getElementById('tables');
  // Gera apenas as tabelas (est√£o ocultas na tela)
  html2pdf().set(opt).from(node).save();
}
</script>
</body>
</html>