# Write a complete index.html with corrected graphs (no label overlap), correct BRL values, 
# PDF export with tables-only, and drill interactivity. It loads the CSV from the user's GitHub.
html = r"""<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Painel do Novo PAC ‚Äì Rio Grande do Sul</title>

<!-- Libs -->
<script src="https://cdn.plot.ly/plotly-2.35.3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --bg:#ffffff; --panel:#f6f7f8; --text:#0b0b0b; --muted:#666;
  --accent:#e11d2e; --border:#e1e2e5;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;padding:18px;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
.wrap{max-width:1500px;margin:0 auto}
h1{margin:0 0 6px;font-size:26px}
h2{margin:0 0 10px;font-size:20px;color:var(--accent)}
.meta{color:var(--muted);margin-bottom:10px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin:0 0 18px}
select{padding:8px 10px;border:1px solid #b9bdc0;border-radius:8px;background:var(--bg);color:var(--text);margin-right:10px}
.btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
.btn-accent{background:var(--accent);color:#fff}
.btn-muted{background:#999;color:#fff}
.topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto;display:flex;gap:8px;align-items:center}
#valorTotal{background:var(--accent);color:#fff;padding:14px;border-radius:12px;text-align:center;font-size:28px;font-weight:700}
.kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpi{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 12px;min-width:180px}
.kpi b{display:block;font-size:18px;margin-top:4px}
.chart{height:420px}
.scroll-x{overflow-x:auto}
.vscroll{max-height:640px;overflow-y:auto}
.chart.wide{width:1700px}
.chart.wider{width:2200px}
.small{font-size:12px;color:var(--muted)}
.badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.badge{background:#eef0f2;color:#111;border-radius:20px;padding:4px 10px;font-size:12px;border:1px solid var(--border)}
.badge .x{margin-left:6px;cursor:pointer}
footer{margin-top:14px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap" id="pagina">
  <div class="topbar">
    <div>
      <h1>Painel do Novo PAC ‚Äì Rio Grande do Sul</h1>
      <div class="meta">Fonte: Novo PAC (2023‚Äì2030) ‚Äì Casa Civil / Governo Federal ‚Äî atualiza√ß√£o agosto/2025</div>
    </div>
    <div class="right">
      <button id="pdfBtn" class="btn btn-accent" title="Baixar PDF com tabelas">üìÑ PDF (tabelas)</button>
    </div>
  </div>

  <div id="valorTotal">Total: R$ 0,00</div>
  <div class="kpis">
    <div class="kpi"><div class="small">Empreendimentos</div><b id="kpiProj">‚Äì</b></div>
    <div class="kpi"><div class="small">Munic√≠pios</div><b id="kpiMuni">‚Äì</b></div>
    <div class="kpi"><div class="small">Execu√ß√£o m√©dia</div><b id="kpiExec">‚Äì</b></div>
  </div>

  <div class="card">
    <div class="topbar">
      <div>
        <b>Atualiza√ß√£o:</b>
        <select id="selAtual"></select>
        <b>Munic√≠pio:</b>
        <select id="selMuni"><option>Todos</option></select>
      </div>
      <div class="right">
        <button id="resetBtn" class="btn btn-muted">üîÑ Reset filtros</button>
      </div>
    </div>
    <div class="badges" id="badges"></div>
  </div>

  <div class="card">
    <h2>Estrutura Hier√°rquica</h2>
    <div id="hier"></div>
  </div>

  <div class="card"><h2>Tipo de Executor</h2><div id="chartExecutor" class="chart"></div></div>
  <div class="card"><h2>Est√°gio</h2><div id="chartEstagio" class="chart"></div></div>

  <div class="card"><h2>Classifica√ß√£o</h2><div id="chartClassificacao" class="chart"></div></div>

  <div class="card scroll-x"><h2>Eixo</h2><div id="chartEixo" class="chart wide"></div></div>

  <div class="card vscroll"><h2>Subeixo</h2><div id="chartSubeixo" class="chart"></div></div>
  <div class="card vscroll"><h2>Modalidade</h2><div id="chartModalidade" class="chart"></div></div>
  <div class="card vscroll"><h2>Empreendimentos</h2><div id="chartEmp" class="chart"></div></div>

  <div class="small">Clique em qualquer gr√°fico para filtrar; clique novamente para desfazer. Use ‚ÄúReset filtros‚Äù para limpar tudo.</div>

  <footer>Fonte: Novo PAC (2023‚Äì2030) ‚Äì Casa Civil / Governo Federal ‚Äî atualiza√ß√£o agosto/2025</footer>
</div>

<script>
// ========= CONFIG =========
const CSV_FILE = "https://raw.githack.com/lucascunha1979/painel_pac/main/pac_abril_julho_agosto_v1.csv";

// ========= HELPERS =========
const BRL = (n) => {
  if (!isFinite(n)) return "R$ 0,00";
  return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL", minimumFractionDigits: 2, maximumFractionDigits: 2 });
};
const parseMoney = (s) => {
  if (s == null) return 0;
  return parseFloat(String(s).replace(/R\$|\s|\./g,"").replace(",", ".")) || 0;
};
const parsePct = (s) => {
  if (s == null) return 0;
  return parseFloat(String(s).replace("%","").replace(",", ".")) || 0;
};
// wrap words with <br> every N characters (on spaces)
const wrap = (txt, len=18) => String(txt||"").replace(new RegExp(`(?![^\\n]{1,${len}}$)([^\\n]{1,${len}})\\s`,"g"),"$1<br>");
// small helper for default update order
const byUpdateOrder = v => { const x = String(v||"").toLowerCase();
  if (x.includes("abr")) return 1;
  if (x.includes("jul")) return 2;
  if (x.includes("ago")) return 3;
  return 0;
};

// ========= STATE =========
let RAW = [];
let FILTERS = { Atual:null, Muni:"Todos" };
let DRILL = { Executor:null, Estagio:null, Classificacao:null, Eixo:null, Subeixo:null, Modalidade:null };

// ========= LOAD CSV =========
Papa.parse(CSV_FILE,{
  download:true, header:true, skipEmptyLines:true,
  complete: (res)=>{
    RAW = res.data.map(r=>({
      Atual: r["Atualiza√ß√£o"] || r["Atualizacao"] || "",
      Muni:  r["Munic√≠pio"]   || r["Municipio"]   || "",
      Executor: r["Tipo de Executor"] || "",
      Estagio:  r["Est√°gio"] || r["Estagio"] || "",
      Classificacao: r["Classifica√ß√£o"] || r["Classificacao"] || "",
      Eixo: r["Eixo"] || "",
      Subeixo: r["Subeixo"] || "",
      Modalidade: r["Modalidade"] || "",
      Emp: r["Empreendimento"] || "",
      Valor: parseMoney(r["Estimativa do valor total do empreendimento no Novo PAC (2023-2030) (R$)"]),
      ExecPct: parsePct(r["Percentual de execu√ß√£o do empreendimento (%)"]),
    })).filter(r=>r.Atual && r.Eixo);

    initFilters();
    renderAll();
  },
  error:(e)=>alert("Erro ao carregar CSV: "+e.message)
});

// ========= FILTERS =========
function initFilters(){
  const u = [...new Set(RAW.map(d=>d.Atual))].sort((a,b)=>byUpdateOrder(a)-byUpdateOrder(b));
  selAtual.innerHTML = u.map(v=>`<option>${v}</option>`).join("");
  FILTERS.Atual = u[u.length-1] || "";
  selAtual.value = FILTERS.Atual;
  selAtual.onchange = e => { FILTERS.Atual = e.target.value; renderAll(); };

  const m = [...new Set(RAW.map(d=>d.Muni))].filter(Boolean).sort();
  m.forEach(v=> selMuni.innerHTML += `<option>${v}</option>`);
  selMuni.onchange = e => { FILTERS.Muni = e.target.value; renderAll(); };

  document.getElementById("resetBtn").onclick = ()=>{
    DRILL = { Executor:null, Estagio:null, Classificacao:null, Eixo:null, Subeixo:null, Modalidade:null };
    renderAll();
  };
}

function activeRows(){
  return RAW.filter(r =>
    r.Atual === FILTERS.Atual &&
    (FILTERS.Muni==="Todos" || r.Muni===FILTERS.Muni) &&
    (!DRILL.Executor || r.Executor===DRILL.Executor) &&
    (!DRILL.Estagio || r.Estagio===DRILL.Estagio) &&
    (!DRILL.Classificacao || r.Classificacao===DRILL.Classificacao) &&
    (!DRILL.Eixo || r.Eixo===DRILL.Eixo) &&
    (!DRILL.Subeixo || r.Subeixo===DRILL.Subeixo) &&
    (!DRILL.Modalidade || r.Modalidade===DRILL.Modalidade)
  );
}

function renderBadges(){
  const b = [];
  for (const [k,v] of Object.entries(DRILL)) if (v) b.push(`<span class="badge">${k}: ${v}<span class="x" data-k="${k}">‚úï</span></span>`);
  badges.innerHTML = b.join("") || `<span class="small">Nenhum filtro aplicado.</span>`;
  badges.querySelectorAll(".x").forEach(x=> x.onclick = (e)=>{ const k=e.target.dataset.k; DRILL[k]=null; renderAll(); });
}

// ========= AGG =========
function aggWeighted(key){
  const m = {};
  activeRows().forEach(r=>{
    const k = r[key] || "N√£o informado";
    if(!m[k]) m[k]={sum:0, w:0};
    m[k].sum += r.Valor;
    m[k].w   += r.Valor * (r.ExecPct/100);
  });
  return Object.entries(m).map(([k,o])=>({k, v:o.sum, exec: o.sum? (o.w/o.sum*100):0})).sort((a,b)=>b.v-a.v);
}

// ========= HIER & KPIs =========
function renderHierarchyAndKPIs(){
  const f = activeRows();
  const uniq = arr => new Set(arr).size;
  hier.innerHTML = `
    <div class="kpis" style="margin-top:0">
      <div class="kpi"><div class="small">Eixos</div><b>${uniq(f.map(x=>x.Eixo))}</b></div>
      <div class="kpi"><div class="small">Subeixos</div><b>${uniq(f.map(x=>x.Subeixo))}</b></div>
      <div class="kpi"><div class="small">Modalidades</div><b>${uniq(f.map(x=>x.Modalidade))}</b></div>
      <div class="kpi"><div class="small">Empreendimentos</div><b>${uniq(f.map(x=>x.Emp))}</b></div>
    </div>`;
  const total = f.reduce((a,r)=>a+r.Valor,0);
  valorTotal.textContent = `Total: ${BRL(total)}`;
  kpiProj.textContent   = f.length.toLocaleString("pt-BR");
  kpiMuni.textContent   = new Set(f.map(x=>x.Muni)).size.toLocaleString("pt-BR");
  const execMedia = f.length ? (f.reduce((a,r)=>a+r.ExecPct,0)/f.length) : 0;
  kpiExec.textContent   = `${execMedia.toFixed(1).replace(".",",")}%`;
}

// ========= PLOTS =========
function attachClickFilter(el, key, horizontal=false){
  el.on('plotly_click', d=>{
    const label = horizontal ? d.points[0].y : d.points[0].x;
    const plain = String(label).replace(/<br>/g," ");
    const cur = DRILL[key];
    DRILL[key] = (cur===plain) ? null : plain;
    renderAll();
  });
}

function piePlot(divId, key){
  const a = aggWeighted(key);
  const node = document.getElementById(divId);
  Plotly.newPlot(node,[{
    labels:a.map(x=>wrap(x.k,20)),
    values:a.map(x=>x.v),
    type:"pie", hole:.25, textinfo:"label+percent",
    hovertemplate:"%{label}<br><b>%{customdata}</b><extra></extra>",
    customdata:a.map(x=>BRL(x.v))
  }],{
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    legend:{orientation:"h"}
  },{responsive:true});
  attachClickFilter(node, key, false);
}

function barPlotVertical(divId, key, options={}){
  const a = aggWeighted(key);
  const node = document.getElementById(divId);

  // bottom margin big to avoid label cut; wrap labels
  const labels = a.map(x=>wrap(x.k,16));
  const data = [{
    x: labels,
    y: a.map(x=>x.v),
    type:"bar",
    marker:{color:"#e11d2e"},
    customdata: a.map(x=>BRL(x.v)),
    meta: a.map(x=>x.exec.toFixed(1).replace(".",",")),
    hovertemplate:"%{x}<br><b>%{customdata}</b><br>Exec. m√©dia: %{meta}%<extra></extra>"
  }];

  const layout = {
    paper_bgcolor:"rgba(0,0,0,0)",
    plot_bgcolor:"rgba(0,0,0,0)",
    margin:{l:70,r:20,t:10,b:220}, // <- grande para nomes longos
    xaxis:{
      automargin:true,
      tickangle:0, // sem inclinar, pois usamos wrap
    },
    yaxis:{
      automargin:true,
      separatethousands:true,
      tickprefix:"R$ "
    }
  };

  Plotly.newPlot(node, data, layout, {responsive:true});
  attachClickFilter(node, key, false);
}

function barPlotHorizontal(divId, key){
  const a = aggWeighted(key);
  const node = document.getElementById(divId);

  // dynamic height to spread labels (no overlap)
  const base = 26; // px per category
  const h = Math.min(1200, Math.max(420, base * a.length + 120));
  node.style.height = h + "px";

  const data = [{
    x: a.map(x=>x.v),
    y: a.map(x=>wrap(x.k,36)),
    type:"bar",
    orientation:"h",
    marker:{color:"#e11d2e"},
    customdata: a.map(x=>BRL(x.v)),
    meta: a.map(x=>x.exec.toFixed(1).replace(".",",")),
    hovertemplate:"%{y}<br><b>%{customdata}</b><br>Exec. m√©dia: %{meta}%<extra></extra>"
  }];

  const layout = {
    paper_bgcolor:"rgba(0,0,0,0)",
    plot_bgcolor:"rgba(0,0,0,0)",
    margin:{l:340,r:20,t:10,b:40},
    xaxis:{separatethousands:true, tickprefix:"R$ "},
    yaxis:{automargin:true}
  };

  Plotly.newPlot(node, data, layout, {responsive:true});
  attachClickFilter(node, key, true);
}

// ========= TABLES FOR PDF =========
function buildTables(){
  // returns an array of tables [{title, headers, rows}]
  const tables = [];
  const f = activeRows();

  // Helper to aggregate
  const sumBy = (key) => {
    const map = {};
    f.forEach(r=>{
      const k = r[key] || "N√£o informado";
      if(!map[k]) map[k]={valor:0, execSum:0, cnt:0};
      map[k].valor += r.Valor;
      map[k].execSum += r.ExecPct;
      map[k].cnt += 1;
    });
    return Object.entries(map).map(([k,o])=>({
      categoria: k,
      valor: o.valor,
      execMedia: o.cnt? o.execSum/o.cnt : 0,
      qtd: o.cnt
    })).sort((a,b)=>b.valor-a.valor);
  };

  const sections = [
    ["Eixo","Eixo"],
    ["Subeixo","Subeixo"],
    ["Modalidade","Modalidade"],
    ["Classifica√ß√£o","Classificacao"],
    ["Est√°gio","Estagio"],
    ["Tipo de Executor","Executor"],
    ["Empreendimentos","Emp"],
  ];

  sections.forEach(([title, key])=>{
    const agg = sumBy(key);
    const rows = agg.map(o=>[o.categoria, BRL(o.valor), o.qtd.toLocaleString("pt-BR"), (o.execMedia.toFixed(1).replace(".",","))+"%"]);
    tables.push({title, headers:["Categoria","Soma Valor (R$)","Qtd.","Execu√ß√£o m√©dia"], rows});
  });

  return tables;
}

document.getElementById("pdfBtn").onclick = ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("l","pt","a4");
  const pageW = doc.internal.pageSize.getWidth();

  // Header info
  const f = activeRows();
  const total = f.reduce((a,r)=>a+r.Valor,0);
  const execMedia = f.length ? (f.reduce((a,r)=>a+r.ExecPct,0)/f.length) : 0;
  doc.setFontSize(14);
  doc.text("Relat√≥rio de Tabelas ‚Äì Painel do Novo PAC ‚Äì RS", pageW/2, 28, {align:"center"});
  doc.setFontSize(10);
  doc.text(`Atualiza√ß√£o: ${FILTERS.Atual}   |   Munic√≠pio: ${FILTERS.Muni}   |   Total: ${BRL(total)}   |   Empreendimentos: ${f.length}   |   Execu√ß√£o m√©dia: ${execMedia.toFixed(1).replace(".",",")}%`, 28, 48);

  const tables = buildTables();
  let y = 62;
  tables.forEach((t, idx)=>{
    doc.setFontSize(12);
    doc.text(t.title, 28, y);
    y += 6;
    doc.autoTable({
      startY: y,
      head: [t.headers],
      body: t.rows,
      styles: {fontSize:8, cellPadding:2},
      headStyles: {fillColor:[225,29,46]},
      theme: "grid",
      margin: {left:28, right:28},
      didDrawPage: (data)=>{ y = data.cursor.y + 18; }
    });
  });

  doc.setFontSize(8);
  doc.text("Fonte: Novo PAC (2023‚Äì2030) ‚Äì Casa Civil / Governo Federal ‚Äî atualiza√ß√£o agosto/2025", pageW/2, doc.internal.pageSize.getHeight()-16, {align:"center"});

  doc.save("tabelas_pac_rs.pdf");
};

// ========= RENDER ALL =========
function renderAll(){
  renderHierarchyAndKPIs();
  renderBadges();
  piePlot("chartExecutor","Executor");
  piePlot("chartEstagio","Estagio");
  barPlotVertical("chartClassificacao","Classificacao");   // fix margin + wrap labels
  barPlotVertical("chartEixo","Eixo");                     // fix margin + wrap labels
  barPlotHorizontal("chartSubeixo","Subeixo");
  barPlotHorizontal("chartModalidade","Modalidade");
  barPlotHorizontal("chartEmp","Emp");
}
</script>
</body>
</html>
"""
with open("/mnt/data/index.html","w", encoding="utf-8") as f:
    f.write(html)
print("index.html gravado em /mnt/data/index.html")
