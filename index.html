<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel do Novo PAC ‚Äì Rio Grande do Sul</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Libs para gr√°ficos e CSV -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- Libs de PDF (somente tabelas) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<style>
:root{ --bg:#ffffff; --panel:#f4f5f7; --text:#111; --muted:#555; --accent:#e11d2e; }
.dark { --bg:#0a0a0a; --panel:#181a1b; --text:#fff; --muted:#c9c9c9; --accent:#ef4444; }
*{box-sizing:border-box}
body{margin:0;padding:18px;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
.wrap{max-width:1500px;margin:0 auto}
h1{margin:0 0 6px;font-size:26px}
h2{margin:0 0 10px;font-size:20px;color:var(--accent)}
.meta{color:var(--muted);margin-bottom:10px}
.card{background:var(--panel);border:1px solid #d6d7da;border-radius:12px;padding:16px;margin:0 0 18px}
.dark .card{border-color:#2a2d2f}
select{padding:8px 10px;border:1px solid #b9bdc0;border-radius:8px;background:var(--bg);color:var(--text);margin-right:10px}
.dark select{border-color:#3c4043}
.btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
.btn-accent{background:var(--accent);color:#fff}
.btn-muted{background:#999;color:#fff}
.topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto;display:flex;gap:8px}
#valorTotal{background:var(--accent);color:#fff;padding:14px;border-radius:12px;text-align:center;font-size:28px;font-weight:700}
.kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpi{background:var(--panel);border:1px solid #d6d7da;border-radius:10px;padding:10px 12px;min-width:180px}
.dark .kpi{border-color:#2a2d2f}
.kpi b{display:block;font-size:18px;margin-top:4px}
.chart{height:420px}
.scroll-x{overflow-x:auto}
.chart.wide{width:1700px}
.chart.wider{width:2200px}
.badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.badge{background:#e8eaed;color:#111;border-radius:20px;padding:4px 10px;font-size:12px;border:1px solid #cfd1d4}
.dark .badge{background:#2a2d2f;color:#fff;border-color:#3a3d40}
.badge .x{margin-left:6px;cursor:pointer}
.small{font-size:12px;color:var(--muted)}
/* Evita r√≥tulos cortados nos dois gr√°ficos pedidos */
.tight-bottom{height:460px}
.tight-bottom .xtick text{white-space:normal!important}
</style>
</head>
<body>
<div class="wrap" id="pagina">
  <div class="topbar">
    <div>
      <h1>Painel do Novo PAC ‚Äì Rio Grande do Sul</h1>
      <div class="meta">Fonte: Novo PAC (2023‚Äì2030) ‚Äì Casa Civil / Governo Federal ‚Äî atualiza√ß√£o: agosto/2025</div>
    </div>
    <div class="right">
      <button id="themeBtn" class="btn btn-accent" title="Alternar tema">üåô/‚òÄÔ∏è</button>
      <button id="pdfBtn" class="btn btn-accent" title="Baixar PDF (apenas tabelas)">üìÑ PDF (tabelas)</button>
    </div>
  </div>

  <div id="valorTotal">Total: R$ 0,00</div>
  <div class="kpis">
    <div class="kpi"><div class="small">Empreendimentos</div><b id="kpiProj">‚Äì</b></div>
    <div class="kpi"><div class="small">Munic√≠pios</div><b id="kpiMuni">‚Äì</b></div>
    <div class="kpi"><div class="small">Execu√ß√£o m√©dia</div><b id="kpiExec">‚Äì</b></div>
  </div>

  <div class="card">
    <div class="topbar">
      <div>
        <b>Atualiza√ß√£o:</b>
        <select id="selAtual"></select>
        <b>Munic√≠pio:</b>
        <select id="selMuni"><option>Todos</option></select>
      </div>
      <div class="right">
        <button id="resetBtn" class="btn btn-muted">üîÑ Reset filtros</button>
      </div>
    </div>
    <div class="badges" id="badges"></div>
  </div>

  <div class="card">
    <h2>Estrutura Hier√°rquica</h2>
    <div id="hier"></div>
  </div>

  <!-- Gr√°ficos interativos (mantidos); N√ÉO entram no PDF -->
  <div class="card"><h2>Tipo de Executor</h2><div id="chartExecutor" class="chart"></div></div>
  <div class="card"><h2>Est√°gio</h2><div id="chartEstagio" class="chart"></div></div>

  <div class="card tight-bottom"><h2>Classifica√ß√£o</h2><div id="chartClassificacao" class="chart"></div></div>
  <div class="card tight-bottom"><h2>Eixo</h2><div id="chartEixo" class="chart"></div></div>

  <div class="card scroll-x"><h2>Subeixo</h2><div id="chartSubeixo" class="chart wide"></div></div>
  <div class="card scroll-x"><h2>Modalidade</h2><div id="chartModalidade" class="chart wide"></div></div>
  <div class="card scroll-x"><h2>Empreendimentos</h2><div id="chartEmp" class="chart wider"></div></div>

  <div class="small">Clique em qualquer gr√°fico para filtrar; clique novamente para desfazer. ‚ÄúPDF (tabelas)‚Äù exporta apenas as tabelas agregadas por categoria (sem gr√°ficos).</div>
</div>

<script>
// ======= CONFIG =======
const CSV_FILE = "https://raw.githack.com/lucascunha1979/painel_pac/main/pac_abril_julho_agosto_v1.csv";

// ======= HELPERS =======
const BRL = n => {
  if (!isFinite(n)) return "R$¬†0,00";
  return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL", minimumFractionDigits:2, maximumFractionDigits:2 });
};
const parseMoney = s => parseFloat(String(s||"").replace(/R\$|\s|\./g,"").replace(",", "."))||0;
const parsePct   = s => parseFloat(String(s||"").replace("%","").replace(",", "."))||0;
const wrap = (txt, len=22) => String(txt||"").replace(new RegExp(`(?![^\\n]{1,${len}}$)([^\\n]{1,${len}})\\s`,"g"),"$1<br>");
const byUpdateOrder = v => { const x = String(v||"").toLowerCase();
  if (x.includes("abr")) return 1;
  if (x.includes("jul")) return 2;
  if (x.includes("ago")) return 3;
  return 0;
};

// ======= STATE =======
let RAW = [];
let FILTERS = { Atual:null, Muni:"Todos" };
let DRILL = { Executor:null, Estagio:null, Classificacao:null, Eixo:null, Subeixo:null, Modalidade:null };

// ======= LOAD CSV =======
Papa.parse(CSV_FILE,{
  download:true, header:true, skipEmptyLines:true,
  complete: (res)=>{
    RAW = res.data.map(r=>({
      Atual:r["Atualiza√ß√£o"]||r["Atualizacao"]||"",
      Muni: r["Munic√≠pio"]||r["Municipio"]||"",
      Executor: r["Tipo de Executor"]||"",
      Estagio: r["Est√°gio"]||r["Estagio"]||"",
      Classificacao: r["Classifica√ß√£o"]||r["Classificacao"]||"",
      Eixo: r["Eixo"]||"",
      Subeixo: r["Subeixo"]||"",
      Modalidade: r["Modalidade"]||"",
      Emp: r["Empreendimento"]||"",
      Valor: parseMoney(r["Estimativa do valor total do empreendimento no Novo PAC (2023-2030) (R$)"]),
      ExecPct: parsePct(r["Percentual de execu√ß√£o do empreendimento (%)"])
    })).filter(r=>r.Atual && r.Eixo);

    initFilters();
    renderAll();
  },
  error:(e)=>alert("Erro ao carregar CSV: "+e.message)
});

// ======= FILTERS =======
function initFilters(){
  const u = [...new Set(RAW.map(d=>d.Atual))].sort((a,b)=>byUpdateOrder(a)-byUpdateOrder(b));
  selAtual.innerHTML = u.map(v=>`<option>${v}</option>`).join("");
  FILTERS.Atual = u[u.length-1]; // mais recente
  selAtual.value = FILTERS.Atual;
  selAtual.onchange = e => { FILTERS.Atual = e.target.value; renderAll(); };

  const m = [...new Set(RAW.map(d=>d.Muni))].filter(Boolean).sort();
  m.forEach(v=> selMuni.innerHTML += `<option>${v}</option>`);
  selMuni.onchange = e => { FILTERS.Muni = e.target.value; renderAll(); };

  document.getElementById("resetBtn").onclick = ()=>{ DRILL = { Executor:null, Estagio:null, Classificacao:null, Eixo:null, Subeixo:null, Modalidade:null }; renderAll(); };
  document.getElementById("themeBtn").onclick = ()=>{ document.body.classList.toggle("dark"); };
}

function activeRows(){
  return RAW.filter(r =>
    r.Atual === FILTERS.Atual &&
    (FILTERS.Muni==="Todos" || r.Muni===FILTERS.Muni) &&
    (!DRILL.Executor || r.Executor===DRILL.Executor) &&
    (!DRILL.Estagio || r.Estagio===DRILL.Estagio) &&
    (!DRILL.Classificacao || r.Classificacao===DRILL.Classificacao) &&
    (!DRILL.Eixo || r.Eixo===DRILL.Eixo) &&
    (!DRILL.Subeixo || r.Subeixo===DRILL.Subeixo) &&
    (!DRILL.Modalidade || r.Modalidade===DRILL.Modalidade)
  );
}

function renderBadges(){
  const b = [];
  for (const [k,v] of Object.entries(DRILL)) if (v) b.push(`<span class="badge">${k}: ${v}<span class="x" data-k="${k}">‚úï</span></span>`);
  badges.innerHTML = b.join("") || `<span class="small">Nenhum filtro aplicado.</span>`;
  badges.querySelectorAll(".x").forEach(x=> x.onclick = (e)=>{ const k=e.target.dataset.k; DRILL[k]=null; renderAll(); });
}

// ======= AGG =======
function aggWeighted(key){
  const m = {};
  activeRows().forEach(r=>{
    const k = r[key] || "N√£o informado";
    if(!m[k]) m[k]={sum:0, w:0};
    m[k].sum += r.Valor;
    m[k].w   += r.Valor * (r.ExecPct/100);
  });
  return Object.entries(m).map(([k,o])=>({k, v:o.sum, exec: o.sum? (o.w/o.sum*100):0})).sort((a,b)=>b.v-a.v);
}

// ======= HIER & KPIS =======
function renderHierarchyAndKPIs(){
  const f = activeRows();
  const uniq = arr => new Set(arr).size;
  hier.innerHTML = `
    <div class="kpis" style="margin-top:0">
      <div class="kpi"><div class="small">Eixos</div><b>${uniq(f.map(x=>x.Eixo))}</b></div>
      <div class="kpi"><div class="small">Subeixos</div><b>${uniq(f.map(x=>x.Subeixo))}</b></div>
      <div class="kpi"><div class="small">Modalidades</div><b>${uniq(f.map(x=>x.Modalidade))}</b></div>
      <div class="kpi"><div class="small">Empreendimentos</div><b>${uniq(f.map(x=>x.Emp))}</b></div>
    </div>`;
  const total = f.reduce((a,r)=>a+r.Valor,0);
  valorTotal.textContent = `Total: ${BRL(total)}`;
  kpiProj.textContent   = f.length.toLocaleString("pt-BR");
  kpiMuni.textContent   = new Set(f.map(x=>x.Muni)).size.toLocaleString("pt-BR");
  const execMedia = f.length ? f.reduce((a,r)=>a+r.ExecPct,0)/f.length : 0;
  kpiExec.textContent   = `${execMedia.toFixed(2).replace(".",",")}%`;
}

// ======= PLOTS (mantidos) =======
function piePlot(divId, key){
  const a = aggWeighted(key);
  Plotly.newPlot(divId,[{
    labels:a.map(x=>wrap(x.k,20)),
    values:a.map(x=>x.v),
    type:"pie", hole:.25, textinfo:"label+percent",
    hovertemplate:"%{label}<br><b>%{customdata}</b><br>Exec. m√©dia: %{meta}%<extra></extra>",
    customdata:a.map(x=>BRL(x.v)),
    meta:a.map(x=>x.exec.toFixed(1).replace(".",","))
  }],{
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    font:{color:getComputedStyle(document.body).getPropertyValue('--text')},
    legend:{orientation:"h"}
  },{responsive:true});

  const el = document.getElementById(divId);
  el.on('plotly_click', d=>{
    const label = d.points[0].label.replace(/<br>/g," ");
    const cur = DRILL[key];
    DRILL[key] = (cur===label) ? null : label;
    renderAll();
  });
}

function barPlot(divId, key, opts={}){
  const a = aggWeighted(key);
  const cfg = Object.assign({horizontal:false,widthClass:"wide"}, opts);

  const x = cfg.horizontal ? a.map(x=>x.v) : a.map(x=>wrap(x.k,22));
  const y = cfg.horizontal ? a.map(x=>wrap(x.k,28)) : a.map(x=>x.v);

  const data = [{
    x, y,
    type:"bar",
    orientation: cfg.horizontal ? "h" : "v",
    marker:{color:getComputedStyle(document.body).getPropertyValue('--accent')},
    customdata: a.map(x=>BRL(x.v)),
    meta: a.map(x=>x.exec.toFixed(1).replace(".",",")),
    hovertemplate: cfg.horizontal
      ? "%{y}<br><b>%{customdata}</b><br>Exec. m√©dia: %{meta}%<extra></extra>"
      : "%{x}<br><b>%{customdata}</b><br>Exec. m√©dia: %{meta}%<extra></extra>"
  }];

  const layout = {
    paper_bgcolor:"rgba(0,0,0,0)",
    plot_bgcolor:"rgba(0,0,0,0)",
    font:{color:getComputedStyle(document.body).getPropertyValue('--text')},
    margin: cfg.horizontal ? {l:300,r:30,t:10,b:40} : {l:80,r:30,t:10,b:170},
    xaxis: { automargin:true, tickangle: cfg.horizontal ? 0 : -30, tickformat: cfg.horizontal ? ",.0f" : undefined },
    yaxis: { automargin:true, tickformat: cfg.horizontal ? undefined : ",.0f" }
  };

  Plotly.newPlot(divId, data, layout, {responsive:true});

  const el = document.getElementById(divId);
  el.on('plotly_click', d=>{
    const label = cfg.horizontal ? d.points[0].y : d.points[0].x;
    const plain = String(label).replace(/<br>/g," ");
    const cur = DRILL[key];
    DRILL[key] = (cur===plain) ? null : plain;
    renderAll();
  });
}

// ======= RENDER ALL =======
function renderAll(){
  renderHierarchyAndKPIs();
  renderBadges();
  piePlot("chartExecutor","Executor");
  piePlot("chartEstagio","Estagio");
  barPlot("chartClassificacao","Classificacao");               // vertical (margem maior)
  barPlot("chartEixo","Eixo");                                 // vertical (margem maior)
  barPlot("chartSubeixo","Subeixo");                           // vertical com scroll
  barPlot("chartModalidade","Modalidade",{horizontal:true});   // horizontal
  barPlot("chartEmp","Emp",{horizontal:true});                 // horizontal
}

// ======= PDF: APENAS TABELAS =======
document.getElementById("pdfBtn").onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
  const left = 28, top = 28, gap = 16;
  const fonte = getComputedStyle(document.body).getPropertyValue('--text') ? 'helvetica' : 'helvetica';

  // Cabe√ßalho
  doc.setFont(fonte, "bold"); doc.setFontSize(14);
  doc.text("Relat√≥rio ‚Äì Tabelas agregadas (Novo PAC ‚Äì RS)", left, top);
  doc.setFontSize(10); doc.setFont("helvetica","normal");
  doc.text("Fonte: Novo PAC (2023‚Äì2030) ‚Äì Casa Civil / Governo Federal ‚Äî atualiza√ß√£o agosto/2025", left, top+14);

  // Helper para criar uma tabela por chave
  const dims = [
    ["Executor", "Tipo de Executor"],
    ["Estagio", "Est√°gio"],
    ["Classificacao", "Classifica√ß√£o"],
    ["Eixo", "Eixo"],
    ["Subeixo", "Subeixo"],
    ["Modalidade", "Modalidade"]
  ];
  let startY = top + 28;

  const rowsBase = activeRows();
  const totalValor = rowsBase.reduce((a,r)=>a+r.Valor,0);
  const execMedia = rowsBase.length? rowsBase.reduce((a,r)=>a+r.ExecPct,0)/rowsBase.length : 0;

  doc.text(`Total selecionado: ${BRL(totalValor)} | Empreendimentos: ${rowsBase.length.toLocaleString("pt-BR")} | Execu√ß√£o m√©dia: ${execMedia.toFixed(2).replace(".",",")}%`, left, startY);
  startY += 10 + gap;

  dims.forEach(([key,label], idx)=>{
    const agg = aggWeighted(key); // {k, v, exec}
    const body = agg.map(r=>[r.k, BRL(r.v), r.exec.toFixed(2).replace(".",",") + "%"]);
    doc.setFont("helvetica","bold"); doc.setFontSize(12);
    doc.text(label, left, startY);
    doc.autoTable({
      startY: startY + 6,
      head: [[label, "Soma do Valor (R$)", "Execu√ß√£o m√©dia (%)"]],
      body,
      theme:"grid",
      styles:{ fontSize:8, cellPadding:3 },
      headStyles:{ fillColor:[225,29,46], textColor:255 },
      margin:{ left:left, right:left }
    });
    startY = doc.lastAutoTable.finalY + gap;
    // quebra de p√°gina se necess√°rio
    if (startY > doc.internal.pageSize.getHeight() - 80 && idx < dims.length-1){
      doc.addPage();
      startY = top;
    }
  });

  // Observa√ß√£o final
  if (startY > doc.internal.pageSize.getHeight() - 60) { doc.addPage(); startY = top; }
  doc.setFont("helvetica","italic"); doc.setFontSize(9);
  doc.text("Obs.: Este PDF exporta somente as tabelas agregadas (sem gr√°ficos).", left, startY+6);

  doc.save("painel_pac_rs_tabelas.pdf");
};
</script>
</body>
</html>
