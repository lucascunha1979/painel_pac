<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel Novo PAC ‚Äì Rio Grande do Sul</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{--bg:#0a0a0a;--panel:#1a1a1a;--red:#ef4444;--muted:#ccc;}
body{margin:0;padding:18px;background:var(--bg);color:#fff;font-family:Arial;}
h1{font-size:26px;margin-bottom:6px;}
h2{color:var(--red);margin-bottom:10px;}
.card{background:var(--panel);padding:16px;border-radius:12px;margin-bottom:18px;border:1px solid #222;}
select{padding:8px;background:#000;color:#fff;border:1px solid #555;border-radius:8px;margin-right:10px;}
.chart{height:420px;}
#valorTotal{background:var(--red);padding:14px;border-radius:10px;font-size:30px;font-weight:bold;text-align:center;margin-bottom:20px;}
.hier-box{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-bottom:10px;}
.hitem{background:#f5f5d8;color:#000;padding:10px;border-radius:10px;border:1px solid #aaa;font-weight:bold;text-align:center;min-width:160px;}
.hitem.blue{background:#b7d8eb;}
.arrow{text-align:center;margin:4px 0;}
.scroll-x{overflow-x:auto;}
.chart.wide{width:1400px;}
.chart.wider{width:2000px;}
#btnPDF{position:fixed;bottom:20px;right:20px;background:var(--red);color:#fff;border:0;padding:12px 18px;border-radius:8px;font-weight:bold;cursor:pointer;}
</style>
</head>

<body>
<h1>Painel do Novo PAC ‚Äì Rio Grande do Sul</h1>
<p style="color:#ccc;">Fonte: Casa Civil ‚Äì Governo Federal ‚Äî Atualiza√ß√£o Agosto 2025</p>

<div id="valorTotal">Total: R$ 0</div>

<div class="card">
<b>Atualiza√ß√£o:</b> <select id="selAtual"></select>
<b>Munic√≠pio:</b> <select id="selMuni"><option>Todos</option></select>
</div>

<div class="card">
<h2>Estrutura Hier√°rquica do PAC</h2>
<div id="hier"></div>
</div>

<div class="card"><h2>Tipo de Executor</h2><div id="chartExecutor" class="chart"></div></div>
<div class="card"><h2>Est√°gio</h2><div id="chartEstagio" class="chart"></div></div>
<div class="card"><h2>Classifica√ß√£o</h2><div id="chartClassificacao" class="chart"></div></div>

<div class="card scroll-x"><h2>Eixo</h2><div id="chartEixo" class="chart wide"></div></div>
<div class="card scroll-x"><h2>Subeixo</h2><div id="chartSubeixo" class="chart wide"></div></div>
<div class="card scroll-x"><h2>Modalidade</h2><div id="chartModalidade" class="chart wide"></div></div>
<div class="card scroll-x"><h2>Empreendimentos</h2><div id="chartEmp" class="chart wider"></div></div>

<button id="btnPDF">üìÑ Baixar PDF</button>

<script>
const CSV_FILE = "https://raw.githubusercontent.com/lucascunha1979/painel_pac/main/pac_abril_julho_agosto_v1.csv";

let raw = [];
let filters = { Atualizacao: null, Municipio: "Todos" };

const fmtBR = v => isFinite(v) ? (
  v>=1e9?"R$ "+(v/1e9).toFixed(2)+" bi":
  v>=1e6?"R$ "+(v/1e6).toFixed(2)+" mi":
  "R$ "+v.toLocaleString("pt-BR")
) : "R$ 0";

const parseMoney = s => parseFloat((s||"").replace(/R\$|\./g,"").replace(",","."))||0;
const parsePct = s => parseFloat((s||"").replace("%","").replace(",",".") )||0;

function agg(rows, key){
 let m={};
 rows.forEach(r=>{
  const k=r[key]||"N√£o informado";
  m[k]=(m[k]||0)+r.Valor;
 });
 return Object.entries(m).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
}

function aggExec(rows, key){
 let m={};
 rows.forEach(r=>{
  const k=r[key]||"N√£o informado";
  if(!m[k])m[k]={v:0, w:0};
  m[k].v+=r.Valor;
  m[k].w+=r.Valor*(r.Exec/100);
 });
 return Object.entries(m).map(([k,o])=>({
  k, valor:o.v, exec:o.v? (o.w/o.v*100):0
 })).sort((a,b)=>b.valor-a.valor);
}

function filtered(){
 return raw.filter(r =>
  (filters.Atualizacao===null || r.Atualizacao===filters.Atualizacao) &&
  (filters.Municipio==="Todos" || r.Municipio===filters.Municipio)
 );
}

Papa.parse(CSV_FILE,{
 download:true,
 header:true,
 complete:(res)=>{
  raw = res.data.map(r=>({
   Atualizacao:r["Atualiza√ß√£o"],
   Municipio:r["Munic√≠pio"],
   Executor:r["Tipo de Executor"],
   Estagio:r["Est√°gio"],
   Classificacao:r["Classifica√ß√£o"],
   Eixo:r["Eixo"],
   Subeixo:r["Subeixo"],
   Modalidade:r["Modalidade"],
   Emp:r["Empreendimento"],
   Valor:parseMoney(r["Estimativa do valor total do empreendimento no Novo PAC (2023-2030) (R$)"]),
   Exec:parsePct(r["Percentual de execu√ß√£o do empreendimento (%)"])
  }));

  const selAtual=document.getElementById("selAtual");
  const updates=[...new Set(raw.map(x=>x.Atualizacao))].sort();
  selAtual.innerHTML=updates.map(x=>`<option>${x}</option>`).join("");
  filters.Atualizacao=updates.at(-1);
  selAtual.value=filters.Atualizacao;
  selAtual.onchange=e=>{filters.Atualizacao=e.target.value;renderAll();};

  const selM=document.getElementById("selMuni");
  [...new Set(raw.map(x=>x.Municipio))].sort()
   .forEach(m=>selM.innerHTML+=`<option>${m}</option>`);
  selM.onchange=e=>{filters.Municipio=e.target.value;renderAll();};

  renderAll();
 }
});

function renderHierarchy(){
 let f=filtered(),u=a=>new Set(a).size;
 let html=`
 <div class="hier-box"><div class="hitem">üß≠ Eixos<br><b>${u(f.map(x=>x.Eixo))}</b></div></div>
 <div class="arrow">‚Üì</div>
 <div class="hier-box"><div class="hitem">üîÅ Subeixos<br><b>${u(f.map(x=>x.Subeixo))}</b></div></div>
 <div class="arrow">‚Üì</div>
 <div class="hier-box"><div class="hitem">üì¶ Modalidades<br><b>${u(f.map(x=>x.Modalidade))}</b></div></div>
 <div class="arrow">‚Üì</div>
 <div class="hier-box"><div class="hitem blue">üèóÔ∏è Empreendimentos<br><b>${u(f.map(x=>x.Emp))}</b></div></div>
 `;
 document.getElementById("hier").innerHTML=html;
 document.getElementById("valorTotal").innerText="Total: "+fmtBR(f.reduce((a,b)=>a+b.Valor,0));
}

function pie(id,key){
 let a=aggExec(filtered(),key);
 Plotly.newPlot(id,[{
  labels:a.map(x=>x.k),values:a.map(x=>x.valor),type:"pie",hole:.25,
  textinfo:"label+percent",
  hovertemplate:"%{label}<br><b>"+a.map(x=>fmtBR(x.valor))+ "</b><br>Exec m√©dia: "+a.map(x=>x.exec.toFixed(1))+"%<extra></extra>"
 }],{paper_bgcolor:"#0a0a0a",font:{color:"#fff"}});
}

function bar(id,key){
 let a=aggExec(filtered(),key);
 Plotly.newPlot(id,[{
  x:a.map(x=>x.k),y:a.map(x=>x.valor),type:"bar",marker:{color:"#ef4444"},
  hovertemplate:"%{x}<br><b>%{customdata}</b><br>Exec: %{meta}%%<extra></extra>",
  customdata:a.map(x=>fmtBR(x.valor)),meta:a.map(x=>x.exec.toFixed(1))
 }],{paper_bgcolor:"#0a0a0a",font:{color:"#fff"},margin:{b:140},xaxis:{tickangle:-30}});
}

function barH(id,key){
 let a=aggExec(filtered(),key);
 Plotly.newPlot(id,[{
  x:a.map(x=>x.valor),y:a.map(x=>x.k),orientation:"h",type:"bar",marker:{color:"#ef4444"},
  hovertemplate:"%{y}<br><b>%{customdata}</b><br>Exec: %{meta}%%<extra></extra>",
  customdata:a.map(x=>fmtBR(x.valor)),meta:a.map(x=>x.exec.toFixed(1))
 }],{paper_bgcolor:"#0a0a0a",font:{color:"#fff"},margin:{l:240}});
}

function renderAll(){
 renderHierarchy();
 pie("chartExecutor","Executor");
 pie("chartEstagio","Estagio");
 bar("chartClassificacao","Classificacao");
 bar("chartEixo","Eixo");
 bar("chartSubeixo","Subeixo");
 bar("chartModalidade","Modalidade");
 barH("chartEmp","Emp");
}

document.getElementById("btnPDF").onclick = async()=>{
 const {jsPDF}=window.jspdf;
 const canvas=await html2canvas(document.body,{scale:2});
 const pdf=new jsPDF("landscape");
 pdf.addImage(canvas,"PNG",0,0,295,200);
 pdf.save("Relatorio_PAC_RS.pdf");
};
</script>
</body>
</html>
